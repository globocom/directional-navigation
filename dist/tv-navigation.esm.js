var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},GlobalConfig={selector:"",straightOnly:!1,straightOverlapThreshold:.35,rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:[],navigableFilter:null},KEYMAPPING={4:"left",21:"left",37:"left",214:"left",205:"left",218:"left",5:"right",22:"right",39:"right",213:"right",206:"right",217:"right",29460:"up",19:"up",38:"up",211:"up",203:"up",215:"up",29461:"down",20:"down",40:"down",212:"down",204:"down",216:"down",29443:"enter",13:"enter",67:"enter",32:"enter",23:"enter",195:"enter"},REVERSE={left:"right",up:"down",right:"left",down:"up"},EVENT_PREFIX="sn:",ID_POOL_PREFIX="section-",_idPool=0,_ready=!1,_pause=!1,_sections={},_sectionCount=0,_defaultSectionId="",_lastSectionId="",_duringFocusChange=!1,elementMatchesSelector=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||function(e){var t=(this.parentNode||this.document).querySelectorAll(e);return[].slice.call(t).indexOf(this)>=0};function getRect(e){var t=e.getBoundingClientRect(),n={left:t.left,top:t.top,right:t.right,bottom:t.bottom,width:t.width,height:t.height};return n.element=e,n.center={x:n.left+Math.floor(n.width/2),y:n.top+Math.floor(n.height/2)},n.center.left=n.center.right=n.center.x,n.center.top=n.center.bottom=n.center.y,n}function partition(e,t,n){for(var o=[[],[],[],[],[],[],[],[],[]],r=0;r<e.length;r++){var i,s,a=e[r],c=a.center;if(i=c.x<t.left?0:c.x<=t.right?1:2,o[s=3*(c.y<t.top?0:c.y<=t.bottom?1:2)+i].push(a),-1!==[0,2,6,8].indexOf(s)){var u=n;a.left<=t.right-t.width*u&&(2===s?o[1].push(a):8===s&&o[7].push(a)),a.right>=t.left+t.width*u&&(0===s?o[1].push(a):6===s&&o[7].push(a)),a.top<=t.bottom-t.height*u&&(6===s?o[3].push(a):8===s&&o[5].push(a)),a.bottom>=t.top+t.height*u&&(0===s?o[3].push(a):2===s&&o[5].push(a))}}return o}function generateDistanceFunction(e){return{nearPlumbLineIsBetter:function(t){var n;return(n=t.center.x<e.center.x?e.center.x-t.right:t.left-e.center.x)<0?0:n},nearHorizonIsBetter:function(t){var n;return(n=t.center.y<e.center.y?e.center.y-t.bottom:t.top-e.center.y)<0?0:n},nearTargetLeftIsBetter:function(t){var n;return(n=t.center.x<e.center.x?e.left-t.right:t.left-e.left)<0?0:n},nearTargetTopIsBetter:function(t){var n;return(n=t.center.y<e.center.y?e.top-t.bottom:t.top-e.top)<0?0:n},topIsBetter:function(e){return e.top},bottomIsBetter:function(e){return-1*e.bottom},leftIsBetter:function(e){return e.left},rightIsBetter:function(e){return-1*e.right}}}function prioritize(e){for(var t=null,n=0;n<e.length;n++)if(e[n].group.length){t=e[n];break}if(!t)return null;var o=t.distance;return t.group.sort(function(e,t){for(var n=0;n<o.length;n++){var r=o[n],i=r(e)-r(t);if(i)return i}return 0}),t.group}function navigate(e,t,n,o){if(!(e&&t&&n&&n.length))return null;for(var r=[],i=0;i<n.length;i++){var s=getRect(n[i]);s&&r.push(s)}if(!r.length)return null;var a=getRect(e);if(!a)return null;var c,u=generateDistanceFunction(a),l=partition(r,a,o.straightOverlapThreshold),f=partition(l[4],a.center,o.straightOverlapThreshold);switch(t){case"left":c=[{group:f[0].concat(f[3]).concat(f[6]),distance:[u.nearPlumbLineIsBetter,u.topIsBetter]},{group:l[3],distance:[u.nearPlumbLineIsBetter,u.topIsBetter]},{group:l[0].concat(l[6]),distance:[u.nearHorizonIsBetter,u.rightIsBetter,u.nearTargetTopIsBetter]}];break;case"right":c=[{group:f[2].concat(f[5]).concat(f[8]),distance:[u.nearPlumbLineIsBetter,u.topIsBetter]},{group:l[5],distance:[u.nearPlumbLineIsBetter,u.topIsBetter]},{group:l[2].concat(l[8]),distance:[u.nearHorizonIsBetter,u.leftIsBetter,u.nearTargetTopIsBetter]}];break;case"up":c=[{group:f[0].concat(f[1]).concat(f[2]),distance:[u.nearHorizonIsBetter,u.leftIsBetter]},{group:l[1],distance:[u.nearHorizonIsBetter,u.leftIsBetter]},{group:l[0].concat(l[2]),distance:[u.nearPlumbLineIsBetter,u.bottomIsBetter,u.nearTargetLeftIsBetter]}];break;case"down":c=[{group:f[6].concat(f[7]).concat(f[8]),distance:[u.nearHorizonIsBetter,u.leftIsBetter]},{group:l[7],distance:[u.nearHorizonIsBetter,u.leftIsBetter]},{group:l[6].concat(l[8]),distance:[u.nearPlumbLineIsBetter,u.topIsBetter,u.nearTargetLeftIsBetter]}];break;default:return null}o.straightOnly&&c.pop();var d=prioritize(c);if(!d)return null;var g=null;if(o.rememberSource&&o.previous&&o.previous.destination===e&&o.previous.reverse===t)for(var v=0;v<d.length;v++)if(d[v].element===o.previous.target){g=d[v].element;break}return g||(g=d[0].element),g}function generateId(){for(var e;e=ID_POOL_PREFIX+String(++_idPool),_sections[e];);return e}function parseSelector(e){return"string"==typeof e?[].slice.call(document.querySelectorAll(e)):"object"===(void 0===e?"undefined":_typeof(e))&&e.length?[].slice.call(e):"object"===(void 0===e?"undefined":_typeof(e))&&1===e.nodeType?[e]:[]}function matchSelector(e,t){return"string"==typeof t?elementMatchesSelector.call(e,t):"object"===(void 0===t?"undefined":_typeof(t))&&t.length?t.indexOf(e)>=0:"object"===(void 0===t?"undefined":_typeof(t))&&1===t.nodeType&&e===t}function getCurrentFocusedElement(){var e=document.activeElement;if(e&&e!==document.body)return e}function extend(e){e=e||{};for(var t=1;t<arguments.length;t++)if(arguments[t])for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&void 0!==arguments[t][n]&&(e[n]=arguments[t][n]);return e}function exclude(e,t){Array.isArray(t)||(t=[t]);for(var n,o=0;o<t.length;o++)(n=e.indexOf(t[o]))>=0&&e.splice(n,1);return e}function isNavigable(e,t,n){if(!e||!t||!_sections[t]||_sections[t].disabled)return!1;if(e.offsetWidth<=0&&e.offsetHeight<=0||e.hasAttribute("disabled"))return!1;if(n&&!matchSelector(e,_sections[t].selector))return!1;if("function"==typeof _sections[t].navigableFilter){if(!1===_sections[t].navigableFilter(e,t))return!1}else if("function"==typeof GlobalConfig.navigableFilter&&!1===GlobalConfig.navigableFilter(e,t))return!1;return!0}function getSectionId(e){for(var t in _sections)if(!_sections[t].disabled&&matchSelector(e,_sections[t].selector))return t}function getSectionNavigableElements(e){return parseSelector(_sections[e].selector).filter(function(t){return isNavigable(t,e)})}function getSectionDefaultElement(e){var t=_sections[e].defaultElement;return t?("string"==typeof t&&(t=parseSelector(t)[0]),isNavigable(t,e,!0)?t:null):null}function getSectionLastFocusedElement(e){var t=_sections[e]&&_sections[e].lastFocusedElement;return isNavigable(t,e,!0)?t:null}function fireEvent(e,t,n){var o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];console.log("[fireEvent] type: ",t,", cancelable: ",o);var r=document.createEvent("CustomEvent");return r.initCustomEvent(EVENT_PREFIX+t,!0,o,n),e.dispatchEvent(r)}function focusElement(e,t,n){if(!e)return!1;var o=getCurrentFocusedElement(),r=function(){o&&o.blur(),e.focus(),focusChanged(e,t)};if(_duringFocusChange)return r(),!0;if(_duringFocusChange=!0,_pause)return r(),_duringFocusChange=!1,!0;if(o){var i={nextElement:e,nextSectionId:t,direction:n,native:!1};if(!fireEvent(o,"willunfocus",i))return _duringFocusChange=!1,!1;o.blur(),fireEvent(o,"unfocused",i,!1)}var s={previousElement:o,sectionId:t,direction:n,native:!1};return fireEvent(e,"willfocus",s)?(e.focus(),fireEvent(e,"focused",s,!1),_duringFocusChange=!1,focusChanged(e,t),!0):(_duringFocusChange=!1,!1)}function focusChanged(e,t){t||(t=getSectionId(e)),t&&(_sections[t].lastFocusedElement=e,_lastSectionId=t)}function focusExtendedSelector(e,t){if("@"==e.charAt(0)){return 1==e.length?focusSection():focusSection(e.substr(1))}else{var n=parseSelector(e)[0];if(n){var o=getSectionId(n);if(isNavigable(n,o))return focusElement(n,o,t)}}return!1}function focusSection(e){var t=[],n=function(e){e&&t.indexOf(e)<0&&_sections[e]&&!_sections[e].disabled&&t.push(e)};e?n(e):(n(_defaultSectionId),n(_lastSectionId),Object.keys(_sections).map(n));for(var o=0;o<t.length;o++){var r,i=t[o];if(r="last-focused"==_sections[i].enterTo?getSectionLastFocusedElement(i)||getSectionDefaultElement(i)||getSectionNavigableElements(i)[0]:getSectionDefaultElement(i)||getSectionLastFocusedElement(i)||getSectionNavigableElements(i)[0])return focusElement(r,i)}return!1}function fireNavigatefailed(e,t){fireEvent(e,"navigatefailed",{direction:t},!1)}function gotoLeaveFor(e,t){if(_sections[e].leaveFor&&void 0!==_sections[e].leaveFor[t]){var n=_sections[e].leaveFor[t];if("string"==typeof n)return""===n?null:focusExtendedSelector(n,t);var o=getSectionId(n);if(isNavigable(n,o))return focusElement(n,o,t)}return!1}function focusNext(e,t,n){var o=t.getAttribute("data-sn-"+e);if("string"==typeof o)return!(""===o||!focusExtendedSelector(o,e))||(fireNavigatefailed(t,e),!1);var r={},i=[];for(var s in _sections)r[s]=getSectionNavigableElements(s),i=i.concat(r[s]);var a,c=extend({},GlobalConfig,_sections[n]);if("self-only"==c.restrict||"self-first"==c.restrict){var u=r[n];(a=navigate(t,e,exclude(u,t),c))||"self-first"!=c.restrict||(a=navigate(t,e,exclude(i,u),c))}else a=navigate(t,e,exclude(i,t),c);if(a){_sections[n].previous={target:t,destination:a,reverse:REVERSE[e]};var l=getSectionId(a);if(n!=l){var f,d=gotoLeaveFor(n,e);if(d)return!0;if(null===d)return fireNavigatefailed(t,e),!1;switch(_sections[l].enterTo){case"last-focused":f=getSectionLastFocusedElement(l)||getSectionDefaultElement(l);break;case"default-element":f=getSectionDefaultElement(l)}f&&(a=f)}return focusElement(a,l,e)}return!!gotoLeaveFor(n,e)||(fireNavigatefailed(t,e),!1)}function onKeyDown(e){if(!(!_sectionCount||_pause||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=function(){return e.preventDefault(),e.stopPropagation(),!1},n=getCurrentFocusedElement(),o=getSectionId(n),r=KEYMAPPING[e.keyCode];if(r){if("enter"==r&&n&&o&&!fireEvent(n,"enter-down"))return t();if(!n&&(_lastSectionId&&(n=getSectionLastFocusedElement(_lastSectionId)),!n))return focusSection(),t();if(o)return fireEvent(n,"willmove",{direction:r,sectionId:o,cause:"keydown"})&&focusNext(r,n,o),t()}}}function onKeyUp(e){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)&&!_pause&&_sectionCount&&"center"==KEYMAPPING[e.keyCode]){var t=getCurrentFocusedElement();t&&getSectionId(t)&&(fireEvent(t,"enter-up")||(e.preventDefault(),e.stopPropagation()))}}function onFocus(e){var t=e.target;if(t!==window&&t!==document&&_sectionCount&&!_duringFocusChange){var n=getSectionId(t);if(n){if(_pause)return void focusChanged(t,n);var o={sectionId:n,native:!0};fireEvent(t,"willfocus",o)?(fireEvent(t,"focused",o,!1),focusChanged(t,n)):(_duringFocusChange=!0,t.blur(),_duringFocusChange=!1)}}}function onBlur(e){var t=e.target;if(t!==window&&t!==document&&!_pause&&_sectionCount&&!_duringFocusChange&&getSectionId(t)){var n={native:!0};fireEvent(t,"willunfocus",n)?fireEvent(t,"unfocused",n,!1):(_duringFocusChange=!0,setTimeout(function(){t.focus(),_duringFocusChange=!1}))}}var Navigation={init:function(){_ready||(window.addEventListener("keydown",onKeyDown),window.addEventListener("keyup",onKeyUp),window.addEventListener("focus",onFocus,!0),window.addEventListener("blur",onBlur,!0),_ready=!0)},uninit:function(){window.removeEventListener("blur",onBlur,!0),window.removeEventListener("focus",onFocus,!0),window.removeEventListener("keyup",onKeyUp),window.removeEventListener("keydown",onKeyDown),Navigation.clear(),_idPool=0,_ready=!1},clear:function(){_sections={},_sectionCount=0,_defaultSectionId="",_lastSectionId="",_duringFocusChange=!1},set:function(){var e,t;if("object"===_typeof(arguments[0]))t=arguments[0];else{if("string"!=typeof arguments[0]||"object"!==_typeof(arguments[1]))return;if(e=arguments[0],t=arguments[1],!_sections[e])throw new Error('Section "'+e+"\" doesn't exist!")}for(var n in t)void 0!==GlobalConfig[n]&&(e?_sections[e][n]=t[n]:void 0!==t[n]&&(GlobalConfig[n]=t[n]));e&&(_sections[e]=extend({},_sections[e]))},add:function(){var e,t={};if("object"===_typeof(arguments[0])?t=arguments[0]:"string"==typeof arguments[0]&&"object"===_typeof(arguments[1])&&(e=arguments[0],t=arguments[1]),e||(e="string"==typeof t.id?t.id:generateId()),_sections[e])throw new Error('Section "'+e+'" has already existed!');return _sections[e]={},_sectionCount++,Navigation.set(e,t),e},remove:function(e){if(!e||"string"!=typeof e)throw new Error('Please assign the "sectionId"!');return!!_sections[e]&&(_sections[e]=void 0,_sections=extend({},_sections),_sectionCount--,!0)},disable:function(e){return!!_sections[e]&&(_sections[e].disabled=!0,!0)},enable:function(e){return!!_sections[e]&&(_sections[e].disabled=!1,!0)},pause:function(){_pause=!0},resume:function(){_pause=!1},focus:function(e,t){var n=!1;void 0===t&&"boolean"==typeof e&&(t=e,e=void 0);var o=!_pause&&t;if(o&&Navigation.pause(),e)if("string"==typeof e)n=_sections[e]?focusSection(e):focusExtendedSelector(e);else{var r=getSectionId(e);isNavigable(e,r)&&(n=focusElement(e,r))}else n=focusSection();return o&&Navigation.resume(),n},move:function(e,t){if(e=e.toLowerCase(),!REVERSE[e])return!1;var n=t?parseSelector(t)[0]:getCurrentFocusedElement();if(!n)return!1;var o=getSectionId(n);return!!o&&(!!fireEvent(n,"willmove",{direction:e,sectionId:o,cause:"api"})&&focusNext(e,n,o))},makeFocusable:function(e){var t=function(e){var t=void 0!==e.tabIndexIgnoreList?e.tabIndexIgnoreList:GlobalConfig.tabIndexIgnoreList;parseSelector(e.selector).forEach(function(e){matchSelector(e,t)||e.getAttribute("tabindex")||e.setAttribute("tabindex","-1")})};if(e){if(!_sections[e])throw new Error('Section "'+e+"\" doesn't exist!");t(_sections[e])}else for(var n in _sections)t(_sections[n])},setDefaultSection:function(e){if(e){if(!_sections[e])throw new Error('Section "'+e+"\" doesn't exist!");_defaultSectionId=e}else _defaultSectionId=""},getSectionId:getSectionId},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var MinkowskiDistance=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"chebyshevDistance",value:function(e,t,n,o,r){var i,s=-o;for(i=0;i<n;i+=1)s=r(s,Math.abs(e[i]-t[i]));return s}},{key:"minkowskiDistance",value:function(e,t,n,o,r){var i,s;if(t!==o)throw"Both vectors should have same dimension";if(isNaN(r))throw'The order "p" must be a number';if(r===Number.POSITIVE_INFINITY)return this.chebyshevDistance(e,n,t,r,Math.max);if(r===Number.NEGATIVE_INFINITY)return this.chebyshevDistance(e,n,t,r,Math.min);if(r<1)throw"Order less than 1 will violate the triangle inequality";for(i=0,s=0;s<t;s+=1)i+=Math.pow(Math.abs(e[s]-n[s]),r);return isNaN(i)?0:Math.pow(i,1/r)}},{key:"calculate",value:function(e,t,n){return this.minkowskiDistance(e,e.length,t,t.length,n)}}]),e}();function _classCallCheck$1(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}new MinkowskiDistance;var TVNavigation=function e(){var t=this;_classCallCheck$1(this,e),this.init=function(){Navigation.init(),Navigation.focus(),t.bindFocusEvent()},this.destroy=function(){t.focusedPath=null,Navigation.uninit(),t.unbindFocusEvent()},this.bindFocusEvent=function(){t.listening||(t.listening=!0,document.addEventListener("sn:focused",t.handleFocused))},this.unbindFocusEvent=function(){document.removeEventListener("sn:focused",t.handleFocused),t.listening=!1},this.handleFocused=function(e){t.focusedPath!==e.detail.sectionId&&t.setCurrentFocusedPath(e.detail.sectionId)},this.getCurrentFocusedPath=function(){return t.focusedPath},this.setCurrentFocusedPath=function(e){console.log("setCurrentFocusedPath called."),t.focusedPath=e,Navigation.focus(e)},this.addFocusable=function(e,n){var o=n.focusPath,r=n.onEnterPressHandler;if(e&&!Navigation.getSectionId(e)){t.removeFocusable(e,{onEnterPressHandler:r});var i=[{selector:e}];o&&i.unshift(o),e.addEventListener("sn:enter-down",r);var s=Navigation.add.apply(Navigation,i);Navigation.makeFocusable(s)}},this.removeFocusable=function(e,t){var n=t.onEnterPressHandler,o=Navigation.getSectionId(e);o&&(Navigation.remove(o),e.removeEventListener("sn:enter-down",n))},this.destroy()},tvNavigation=new TVNavigation;export{tvNavigation as TVNavigation};
