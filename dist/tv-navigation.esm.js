var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var MinkowskiDistance=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"chebyshevDistance",value:function(e,t,n,o,r){var i=-o,c=void 0;for(c=0;c<n;c+=1)i=r(i,Math.abs(e[c]-t[c]));return i}},{key:"minkowskiDistance",value:function(e,t,n,o,r){var i=void 0,c=void 0;if(t!==o)throw new Error("Both vectors should have same dimension");if(isNaN(r))throw new Error('The order "p" must be a number');if(r===Number.POSITIVE_INFINITY)return this.chebyshevDistance(e,n,t,r,Math.max);if(r===Number.NEGATIVE_INFINITY)return this.chebyshevDistance(e,n,t,r,Math.min);if(r<1)throw new Error("Order less than 1 will violate the triangle inequality");for(i=0,c=0;c<t;c+=1)i+=Math.pow(Math.abs(e[c]-n[c]),r);return isNaN(i)?0:Math.pow(i,1/r)}},{key:"calculate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;return this.minkowskiDistance(e,e.length,t,t.length,n)}}]),e}(),MinkowskiDistance$1=new MinkowskiDistance,_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],o=!0,r=!1,i=void 0;try{for(var c,s=e[Symbol.iterator]();!(o=(c=s.next()).done)&&(n.push(c.value),!t||n.length!==t);o=!0);}catch(e){r=!0,i=e}finally{try{!o&&s.return&&s.return()}finally{if(r)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},GlobalConfig={selector:"",straightOnly:!1,straightOverlapThreshold:.35,rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:[],navigableFilter:null},KEYMAPPING={4:"left",21:"left",37:"left",214:"left",205:"left",218:"left",5:"right",22:"right",39:"right",213:"right",206:"right",217:"right",29460:"up",19:"up",38:"up",211:"up",203:"up",215:"up",29461:"down",20:"down",40:"down",212:"down",204:"down",216:"down",29443:"enter",13:"enter",67:"enter",32:"enter",23:"enter",195:"enter"},REVERSE={left:"right",up:"down",right:"left",down:"up"},EVENT_PREFIX="sn:",ID_POOL_PREFIX="section-",_idPool=0,_ready=!1,_pause=!1,_sections={},_sectionCount=0,_defaultSectionId="",_lastSectionId="",_duringFocusChange=!1,elementMatchesSelector=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||function(e){var t=(this.parentNode||this.document).querySelectorAll(e);return[].slice.call(t).indexOf(this)>=0},getRect=function(e){var t=e.getBoundingClientRect(),n={left:t.left,top:t.top,right:t.right,bottom:t.bottom,width:t.width,height:t.height};return n.element=e,n.center={x:n.left+Math.floor(n.width/2),y:n.top+Math.floor(n.height/2)},n.center.left=n.center.x,n.center.right=n.center.x,n.center.top=n.center.y,n.center.bottom=n.center.y,n},generateDistanceFunction=function(e){return{nearPlumbLineIsBetter:function(t){var n=void 0;return(n=t.center.x<e.center.x?e.center.x-t.right:t.left-e.center.x)<0?0:n},nearHorizonIsBetter:function(t){var n=void 0;return(n=t.center.y<e.center.y?e.center.y-t.bottom:t.top-e.center.y)<0?0:n},nearTargetLeftIsBetter:function(t){var n=void 0;return(n=t.center.x<e.center.x?e.left-t.right:t.left-e.left)<0?0:n},nearTargetTopIsBetter:function(t){var n=void 0;return(n=t.center.y<e.center.y?e.top-t.bottom:t.top-e.top)<0?0:n},topIsBetter:function(e){return e.top},bottomIsBetter:function(e){return-1*e.bottom},leftIsBetter:function(e){return e.left},rightIsBetter:function(e){return-1*e.right}}},prioritize=function(e){var t=void 0;for(var n in e)if(n.group.length){t=n;break}return t?(t.group.sort(function(e,n){return t.distance.forEach(function(t){var o=t(e)-t(n);if(o)return o}),0}),t.group):null},navigate=function(e,t,n,o){if(!(e&&t&&n&&n.length))return null;var r=getRect(e);if(!r)return null;var i=void 0;if(n.forEach(function(e){var t=getRect(e);t&&i.push(t)}),!i.length)return null;var c=r.center,s=c.targetX,a=c.targetY;i.sort(function(e,t){return MinkowskiDistance$1.calculate([s,a],[e.center.x,e.center.y])>MinkowskiDistance$1.calculate([s,a],[t.center.x,t.center.y])?1:-1});var u=generateDistanceFunction(r),l=void 0;switch(t){case"left":l=[{group:i=i.filter(function(e){return e.center.x<r.center.x}),distance:[u.nearPlumbLineIsBetter,u.topIsBetter]},{group:i,distance:[u.nearHorizonIsBetter,u.rightIsBetter,u.nearTargetTopIsBetter]}];break;case"right":l=[{group:i=i.filter(function(e){return e.center.x>r.center.x}),distance:[u.nearPlumbLineIsBetter,u.topIsBetter]},{group:i,distance:[u.nearHorizonIsBetter,u.leftIsBetter,u.nearTargetTopIsBetter]}];break;case"up":l=[{group:i=i.filter(function(e){return e.center.y<r.center.y}),distance:[u.nearHorizonIsBetter,u.leftIsBetter]},{group:i,distance:[u.nearPlumbLineIsBetter,u.bottomIsBetter,u.nearTargetLeftIsBetter]}];break;case"down":l=[{group:i=i.filter(function(e){return e.center.y>r.center.y}),distance:[u.nearPlumbLineIsBetter,u.topIsBetter,u.nearTargetLeftIsBetter]}];break;default:return null}o.straightOnly&&l.pop();var f=prioritize(l);if(!f)return null;var d=void 0;if(o.rememberSource&&o.previous&&o.previous.destination===e&&o.previous.reverse===t)for(var v in f)if(v.element===o.previous.target){d=v.element;break}return d||(d=f[0].element),d},generateId=function(){var e=void 0;do{e=ID_POOL_PREFIX+String(++_idPool)}while(_sections[e]);return e},parseSelector=function(e){return"string"==typeof e?[].slice.call(document.querySelectorAll(e)):"object"===(void 0===e?"undefined":_typeof(e))&&e.length?[].slice.call(e):"object"===(void 0===e?"undefined":_typeof(e))&&1===e.nodeType?[e]:[]},matchSelector=function(e,t){return"string"==typeof t?elementMatchesSelector.call(e,t):"object"===(void 0===t?"undefined":_typeof(t))&&t.length?t.indexOf(e)>=0:"object"===(void 0===t?"undefined":_typeof(t))&&1===t.nodeType&&e===t},getCurrentFocusedElement=function(){var e=document.activeElement;if(e&&e!==document.body)return e},extend=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];for(var r=e||{},i=1;i<n.length;i++)if(n[i])for(var c in n[i])Object.prototype.hasOwnProperty.call(n[i],c)&&void 0!==n[i][c]&&(r[c]=n[i][c]);return r},exclude=function(e,t){for(var n in Array.from(t)){var o=e.indexOf(n);o>=0&&e.splice(o,1)}return e},isNavigable=function(e,t,n){if(!e||!t||!_sections[t]||_sections[t].disabled)return!1;if(e.offsetWidth<=0&&e.offsetHeight<=0||e.hasAttribute("disabled"))return!1;if(n&&!matchSelector(e,_sections[t].selector))return!1;if("function"==typeof _sections[t].navigableFilter){if(!1===_sections[t].navigableFilter(e,t))return!1}else if("function"==typeof GlobalConfig.navigableFilter&&!1===GlobalConfig.navigableFilter(e,t))return!1;return!0},getSectionId=function(e){for(var t in _sections)if(!_sections[t].disabled&&e&&matchSelector(e,_sections[t].selector))return t},getSectionNavigableElements=function(e){parseSelector(_sections[e].selector).filter(function(t){return isNavigable(t,e)})},getSectionDefaultElement=function(e){var t=_sections[e].defaultElement;if(!t)return null;if("string"==typeof t){var n=parseSelector(t);t=_slicedToArray(n,1)[0]}return isNavigable(t,e,!0)?t:null},getSectionLastFocusedElement=function(e){var t=_sections[e]&&_sections[e].lastFocusedElement;return isNavigable(t,e,!0)?t:null},fireEvent=function(e,t,n){var o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=document.createEvent("CustomEvent");return r.initCustomEvent(EVENT_PREFIX+t,!0,o,n),e.dispatchEvent(r)},focusChanged=function(e,t){var n=t||getSectionId(e);n&&(_sections[n].lastFocusedElement=e,_lastSectionId=n)},focusElement=function(e,t,n){if(!e)return!1;var o=getCurrentFocusedElement(),r=function(){o&&o.blur(),e.focus(),focusChanged(e,t)};if(_duringFocusChange)return r(),!0;if(_duringFocusChange=!0,_pause)return r(),_duringFocusChange=!1,!0;if(o){var i={nextElement:e,nextSectionId:t,direction:n,native:!1};if(!fireEvent(o,"willunfocus",i))return _duringFocusChange=!1,!1;o.blur(),fireEvent(o,"unfocused",i,!1)}var c={previousElement:o,sectionId:t,direction:n,native:!1};return fireEvent(e,"willfocus",c)?(e.focus(),fireEvent(e,"focused",c,!1),_duringFocusChange=!1,focusChanged(e,t),!0):(_duringFocusChange=!1,!1)},focusSection=function(e){var t=[],n=function(e){e&&t.indexOf(e)<0&&_sections[e]&&!_sections[e].disabled&&t.push(e)};for(var o in e?n(e):(n(_defaultSectionId),n(_lastSectionId),Object.keys(_sections).map(n)),t){var r=void 0;if(r="last-focused"===_sections[o].enterTo?getSectionLastFocusedElement(o)||getSectionDefaultElement(o)||getSectionNavigableElements(o)[0]:getSectionDefaultElement(o)||getSectionLastFocusedElement(o)||getSectionNavigableElements(o)[0])return focusElement(r,o)}return!1},focusExtendedSelector=function(e,t){if("@"===e.charAt(0)){if(1===e.length)return focusSection();var n=e.substr(1);return focusSection(n)}var o=parseSelector(e),r=_slicedToArray(o,1)[0];if(r){var i=getSectionId(r);if(isNavigable(r,i))return focusElement(r,i,t)}return!1},fireNavigateFailed=function(e,t){return fireEvent(e,"navigatefailed",{direction:t},!1)},gotoLeaveFor=function(e,t){if(_sections[e].leaveFor&&void 0!==_sections[e].leaveFor[t]){var n=_sections[e].leaveFor[t];if("string"==typeof n)return""===n?null:focusExtendedSelector(n,t);var o=getSectionId(n);if(isNavigable(n,o))return focusElement(n,o,t)}return!1},focusNext=function(e,t,n){var o=t.getAttribute("data-sn-"+e);if("string"==typeof o)return!(""===o||!focusExtendedSelector(o,e))||(fireNavigateFailed(t,e),!1);var r={},i=[];for(var c in _sections)r[c]=getSectionNavigableElements(c),i=i.concat(r[c]);var s=extend({},GlobalConfig,_sections[n]),a=void 0,u=void 0;if("self-only"===s.restrict||"self-first"===s.restrict){var l=r[n];u=exclude(l,t),(a=navigate(t,e,u,s))||"self-first"!==s.restrict||(u=exclude(i,l),a=navigate(t,e,u,s))}else u=exclude(i,t),a=navigate(t,e,u,s);if(a){_sections[n].previous={target:t,destination:a,reverse:REVERSE[e]};var f=getSectionId(a);if(n!==f){var d=gotoLeaveFor(n,e);if(d)return!0;if(null===d)return fireNavigateFailed(t,e),!1;var v=void 0;switch(_sections[f].enterTo){case"last-focused":v=getSectionLastFocusedElement(f)||getSectionDefaultElement(f);break;case"default-element":v=getSectionDefaultElement(f)}v&&(a=v)}return focusElement(a,f,e)}return!!gotoLeaveFor(n,e)||(fireNavigateFailed(t,e),!1)},onKeyDown=function(e){if(console.log(">>>> onKeyDown ",KEYMAPPING[e.keyCode]),!(!_sectionCount||_pause||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=function(){return e.preventDefault(),e.stopPropagation(),!1},n=getCurrentFocusedElement(),o=getSectionId(n),r=KEYMAPPING[e.keyCode];if(r){if("enter"===r&&n&&o&&!fireEvent(n,"enter-down"))return t();if(!n&&(_lastSectionId&&(n=getSectionLastFocusedElement(_lastSectionId)),!n))return focusSection(),t();if(o)return fireEvent(n,"willmove",{direction:r,sectionId:o,cause:"keydown"})&&focusNext(r,n,o),t()}}},onKeyUp=function(e){if(console.log(">>>> onKeyUp ",KEYMAPPING[e.keyCode]),!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)&&!_pause&&_sectionCount&&"center"===KEYMAPPING[e.keyCode]){var t=getCurrentFocusedElement();t&&getSectionId(t)&&(fireEvent(t,"enter-up")||(e.preventDefault(),e.stopPropagation()))}},onFocus=function(e){console.log(">>>> onFocus ",KEYMAPPING[e.keyCode]);var t=e.target;if(t!==window&&t!==document&&_sectionCount&&!_duringFocusChange){var n=getSectionId(t);if(n){if(_pause)return void focusChanged(t,n);var o={sectionId:n,native:!0};fireEvent(t,"willfocus",o)?(fireEvent(t,"focused",o,!1),focusChanged(t,n)):(_duringFocusChange=!0,t.blur(),_duringFocusChange=!1)}}},onBlur=function(e){console.log(">>>> onBlur ",KEYMAPPING[e.keyCode]);var t=e.target;if(t!==window&&t!==document&&!_pause&&_sectionCount&&!_duringFocusChange&&getSectionId(t)){var n={native:!0};fireEvent(t,"willunfocus",n)?fireEvent(t,"unfocused",n,!1):(_duringFocusChange=!0,setTimeout(function(){t.focus(),_duringFocusChange=!1}))}},Navigation={init:function(){_ready||(window.addEventListener("keydown",onKeyDown),window.addEventListener("keyup",onKeyUp),window.addEventListener("focus",onFocus,!0),window.addEventListener("blur",onBlur,!0),_ready=!0)},uninit:function(){window.removeEventListener("blur",onBlur,!0),window.removeEventListener("focus",onFocus,!0),window.removeEventListener("keyup",onKeyUp),window.removeEventListener("keydown",onKeyDown),Navigation.clear(),_idPool=0,_ready=!1},clear:function(){_sections={},_sectionCount=0,_defaultSectionId="",_lastSectionId="",_duringFocusChange=!1},set:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var o=void 0,r=void 0;if("object"===_typeof(t[0]))r=t[0];else{if("string"!=typeof t[0]||"object"!==_typeof(t[1]))return;if(o=t[0],r=t[1],!_sections[o])throw new Error("Section "+o+" doesn't exist!")}for(var i in r)void 0!==GlobalConfig[i]&&(o?_sections[o][i]=r[i]:void 0!==r[i]&&(GlobalConfig[i]=r[i]));o&&(_sections[o]=extend({},_sections[o]))},add:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var o=void 0,r=void 0;if("object"===_typeof(t[0])?r=t[0]:"string"==typeof t[0]&&"object"===_typeof(t[1])&&(o=t[0],r=t[1]),o||(o="string"==typeof r.id?r.id:generateId()),_sections[o])throw new Error("Section "+o+" has already existed!");return _sections[o]={},_sectionCount++,Navigation.set(o,r),o},remove:function(e){if(!e||"string"!=typeof e)throw new Error('Please assign the "sectionId"!');return!!_sections[e]&&(_sections[e]=void 0,_sections=extend({},_sections),_sectionCount--,!0)},disable:function(e){return!!_sections[e]&&(_sections[e].disabled=!0,!0)},enable:function(e){return!!_sections[e]&&(_sections[e].disabled=!1,!0)},pause:function(){_pause=!0},resume:function(){_pause=!1},focus:function(e,t){void 0===t&&"boolean"==typeof e&&(t=e,e=void 0);var n=!_pause&&t;n&&Navigation.pause();var o=void 0;if(e)if("string"==typeof e)o=_sections[e]?focusSection(e):focusExtendedSelector(e);else{var r=getSectionId(e);isNavigable(e,r)&&(o=focusElement(e,r))}else o=focusSection();return n&&Navigation.resume(),o},move:function(e,t){var n=e.toLowerCase();if(!REVERSE[n])return!1;var o=t?parseSelector(t)[0]:getCurrentFocusedElement();if(!o)return!1;var r=getSectionId(o);return!!r&&(!!fireEvent(o,"willmove",{direction:n,sectionId:r,cause:"api"})&&focusNext(n,o,r))},makeFocusable:function(e){var t=function(e){var t=e.tabIndexIgnoreList||GlobalConfig.tabIndexIgnoreList;parseSelector(e.selector).forEach(function(e){matchSelector(e,t)||e.getAttribute("tabindex")||e.setAttribute("tabindex","-1")})};if(e){if(!_sections[e])throw new Error("Section "+e+" doesn't exist!");t(_sections[e])}else for(var n in _sections)t(_sections[n])},setDefaultSection:function(e){if(e){if(!_sections[e])throw new Error("Section "+e+" doesn't exist!");_defaultSectionId=e}else _defaultSectionId=""},getSectionId:getSectionId};function _classCallCheck$1(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var TVNavigation=function e(){var t=this;_classCallCheck$1(this,e),this.init=function(){Navigation.init(),Navigation.focus(),t.bindFocusEvent()},this.destroy=function(){t.focusedPath=null,Navigation.uninit(),t.unbindFocusEvent()},this.bindFocusEvent=function(){t.listening||(t.listening=!0,document.addEventListener("sn:focused",t.handleFocused))},this.unbindFocusEvent=function(){document.removeEventListener("sn:focused",t.handleFocused),t.listening=!1},this.handleFocused=function(e){t.focusedPath!==e.detail.sectionId&&t.setCurrentFocusedPath(e.detail.sectionId)},this.getCurrentFocusedPath=function(){return t.focusedPath},this.setCurrentFocusedPath=function(e){t.focusedPath=e,Navigation.focus(e)},this.addEventListener=function(e,n,o){return document.querySelectorAll(e).forEach(function(e){return e.addEventListener(n,o)}),t},this.addFocusable=function(e,n){if(e&&!Navigation.getSectionId(document.getElementById(e.id))){t.removeFocusable(e);var o=Navigation.add(e);n&&t.addEventListener(e.selector,"sn:enter-down",n),Navigation.makeFocusable(o)}},this.removeFocusable=function(e){var t=Navigation.getSectionId(document.getElementById(e.id));t&&(Navigation.remove(t),document.querySelectorAll(e.selector).removeEventListener("sn:enter-down"))},this.destroy()},tvNavigation=new TVNavigation;export{tvNavigation as TVNavigation};
