var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var MinkowskiDistance=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"chebyshevDistance",value:function(e,t,n,r,o){var i=-r,s=void 0;for(s=0;s<n;s+=1)i=o(i,Math.abs(e[s]-t[s]));return i}},{key:"minkowskiDistance",value:function(e,t,n,r,o){var i=void 0,s=void 0;if(t!==r)throw new Error("Both vectors should have same dimension");if(isNaN(o))throw new Error('The order "p" must be a number');if(o===Number.POSITIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.max);if(o===Number.NEGATIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.min);if(o<1)throw new Error("Order less than 1 will violate the triangle inequality");for(i=0,s=0;s<t;s+=1)i+=Math.pow(Math.abs(e[s]-n[s]),o);return isNaN(i)?0:Math.pow(i,1/o)}},{key:"calculate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;return this.minkowskiDistance(e,e.length,t,t.length,n)}}]),e}(),MinkowskiDistance$1=new MinkowskiDistance,_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},GlobalConfig={selector:"",straightOnly:!1,straightOverlapThreshold:.35,rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:[],navigableFilter:null},KEYMAPPING={4:"left",21:"left",37:"left",214:"left",205:"left",218:"left",5:"right",22:"right",39:"right",213:"right",206:"right",217:"right",29460:"up",19:"up",38:"up",211:"up",203:"up",215:"up",29461:"down",20:"down",40:"down",212:"down",204:"down",216:"down",29443:"enter",13:"enter",67:"enter",32:"enter",23:"enter",195:"enter"},REVERSE={left:"right",up:"down",right:"left",down:"up"},EVENT_PREFIX="sn:",ID_POOL_PREFIX="section-",_idPool=0,_ready=!1,_pause=!1,_sections={},_sectionCount=0,_defaultSectionId="",_lastSectionId="",_duringFocusChange=!1,elementMatchesSelector=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||function(e){var t=(this.parentNode||this.document).querySelectorAll(e);return[].slice.call(t).indexOf(this)>=0},getRect=function(e){var t=e.getBoundingClientRect(),n={left:t.left,top:t.top,right:t.right,bottom:t.bottom,width:t.width,height:t.height};return n.element=e,n.center={x:n.left+Math.floor(n.width/2),y:n.top+Math.floor(n.height/2)},n.center.left=n.center.x,n.center.right=n.center.x,n.center.top=n.center.y,n.center.bottom=n.center.y,n},generateDistanceFunction=function(e){return{nearestIsBetter:function(t){var n=[e.center.x,e.center.y];return MinkowskiDistance$1.calculate(n,[t.center.x,t.center.y])},nearPlumbLineIsBetter:function(t){var n=void 0;return(n=t.center.x<e.center.x?e.center.x-t.right:t.left-e.center.x)<0?0:n},nearHorizonIsBetter:function(t){var n=void 0;return(n=t.center.y<e.center.y?e.center.y-t.bottom:t.top-e.center.y)<0?0:n},nearTargetLeftIsBetter:function(t){var n=void 0;return(n=t.center.x<e.center.x?e.left-t.right:t.left-e.left)<0?0:n},nearTargetTopIsBetter:function(t){var n=void 0;return(n=t.center.y<e.center.y?e.top-t.bottom:t.top-e.top)<0?0:n},topIsBetter:function(e){return e.top},bottomIsBetter:function(e){return-1*e.bottom},leftIsBetter:function(e){return e.left},rightIsBetter:function(e){return-1*e.right}}},prioritize=function(e){for(var t=void 0,n=0;n<e.length;n++)if(e[n].group.length){t=e[n];break}if(!t)return null;var r=t.distance;return t.group.sort(function(e,t){for(var n=0;n<r.length;n++){var o=r[n],i=o(e)-o(t);if(i)return i}return 0}),t.group},navigate=function(e,t,n,r){if(!(e&&t&&n&&n.length))return null;var o=getRect(e);if(!o)return null;var i=[];if(n.forEach(function(e){var t=getRect(e);t&&i.push(t)}),!i.length)return null;var s=generateDistanceFunction(o),a=void 0;switch(t){case"left":a=[{group:i=i.filter(function(e){return e.center.x<o.center.x}),distance:[s.nearHorizonIsBetter,s.nearestIsBetter,s.topIsBetter]}];break;case"right":a=[{group:i=i.filter(function(e){return e.center.x>o.center.x}),distance:[s.nearHorizonIsBetter,s.nearestIsBetter,s.topIsBetter]}];break;case"up":a=[{group:i=i.filter(function(e){return e.center.y<o.center.y}),distance:[s.nearestIsBetter,s.nearHorizonIsBetter,s.leftIsBetter]}];break;case"down":a=[{group:i=i.filter(function(e){return e.center.y>o.center.y}),distance:[s.nearestIsBetter,s.nearPlumbLineIsBetter,s.topIsBetter,s.nearTargetLeftIsBetter]}];break;default:return null}r.straightOnly&&a.pop();var c=prioritize(a);if(!c)return null;var u=void 0;if(r.rememberSource&&r.previous&&r.previous.destination===e&&r.previous.reverse===t)for(var l in c)if(l.element===r.previous.target){u=l.element;break}return u||(u=c[0].element),u},generateId=function(){var e=void 0;do{e=ID_POOL_PREFIX+String(++_idPool)}while(_sections[e]);return e},parseSelector=function(e){return"string"==typeof e?[].slice.call(document.querySelectorAll(e)):"object"===(void 0===e?"undefined":_typeof(e))&&e.length?[].slice.call(e):"object"===(void 0===e?"undefined":_typeof(e))&&1===e.nodeType?[e]:[]},matchSelector=function(e,t){return"string"==typeof t?elementMatchesSelector.call(e,t):"object"===(void 0===t?"undefined":_typeof(t))&&t.length?t.indexOf(e)>=0:"object"===(void 0===t?"undefined":_typeof(t))&&1===t.nodeType&&e===t},getCurrentFocusedElement=function(){var e=document.activeElement;if(e&&e!==document.body)return e},extend=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var o=e||{},i=1;i<n.length;i++)if(n[i])for(var s in n[i])Object.prototype.hasOwnProperty.call(n[i],s)&&void 0!==n[i][s]&&(o[s]=n[i][s]);return o},exclude=function(e,t){for(var n in Array.from(t)){var r=e.indexOf(n);r>=0&&e.splice(r,1)}return e},isNavigable=function(e,t,n){if(!e||!t||!_sections[t]||_sections[t].disabled)return!1;if(e.offsetWidth<=0&&e.offsetHeight<=0||e.hasAttribute("disabled"))return!1;if(n&&!matchSelector(e,_sections[t].selector))return!1;if("function"==typeof _sections[t].navigableFilter){if(!1===_sections[t].navigableFilter(e,t))return!1}else if("function"==typeof GlobalConfig.navigableFilter&&!1===GlobalConfig.navigableFilter(e,t))return!1;return!0},getSectionId=function(e){for(var t in _sections)if(!_sections[t].disabled&&e&&matchSelector(e,_sections[t].selector))return t},getSectionNavigableElements=function(e){return parseSelector(_sections[e].selector).filter(function(t){return isNavigable(t,e)})},getSectionDefaultElement=function(e){var t=_sections[e].defaultElement;if(!t)return null;if("string"==typeof t){var n=parseSelector(t);t=_slicedToArray(n,1)[0]}return isNavigable(t,e,!0)?t:null},getSectionLastFocusedElement=function(e){var t=_sections[e]&&_sections[e].lastFocusedElement;return isNavigable(t,e,!0)?t:null},fireEvent=function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=document.createEvent("CustomEvent");return o.initCustomEvent(EVENT_PREFIX+t,!0,r,n),e.dispatchEvent(o)},focusChanged=function(e,t){var n=t||getSectionId(e);n&&(_sections[n].lastFocusedElement=e,_lastSectionId=n)},focusElement=function(e,t,n){if(!e)return!1;var r=getCurrentFocusedElement(),o=function(){r&&r.blur(),e.focus(),focusChanged(e,t)};if(_duringFocusChange)return o(),!0;if(_duringFocusChange=!0,_pause)return o(),_duringFocusChange=!1,!0;if(r){var i={nextElement:e,nextSectionId:t,direction:n,native:!1};if(!fireEvent(r,"willunfocus",i))return _duringFocusChange=!1,!1;r.blur(),fireEvent(r,"unfocused",i,!1)}var s={previousElement:r,sectionId:t,direction:n,native:!1};return fireEvent(e,"willfocus",s)?(e.focus(),fireEvent(e,"focused",s,!1),_duringFocusChange=!1,focusChanged(e,t),!0):(_duringFocusChange=!1,!1)},focusSection=function(e){var t=[],n=function(e){e&&t.indexOf(e)<0&&_sections[e]&&!_sections[e].disabled&&t.push(e)};e?n(e):(n(_defaultSectionId),n(_lastSectionId),Object.keys(_sections).map(n));for(var r=0;r<t.length;r++){var o=t[r],i=void 0;if(i="last-focused"===_sections[o].enterTo?getSectionLastFocusedElement(o)||getSectionDefaultElement(o)||getSectionNavigableElements(o)[0]:getSectionDefaultElement(o)||getSectionLastFocusedElement(o)||getSectionNavigableElements(o)[0])return focusElement(i,o)}return!1},focusExtendedSelector=function(e,t){if("@"===e.charAt(0)){if(1===e.length)return focusSection();var n=e.substr(1);return focusSection(n)}var r=parseSelector(e),o=_slicedToArray(r,1)[0];if(o){var i=getSectionId(o);if(isNavigable(o,i))return focusElement(o,i,t)}return!1},fireNavigateFailed=function(e,t){return fireEvent(e,"navigatefailed",{direction:t},!1)},gotoLeaveFor=function(e,t){if(_sections[e].leaveFor&&void 0!==_sections[e].leaveFor[t]){var n=_sections[e].leaveFor[t];if("string"==typeof n)return""===n?null:focusExtendedSelector(n,t);var r=getSectionId(n);if(isNavigable(n,r))return focusElement(n,r,t)}return!1},focusNext=function(e,t,n){var r=t.getAttribute("data-sn-"+e);if("string"==typeof r)return!(""===r||!focusExtendedSelector(r,e))||(fireNavigateFailed(t,e),!1);var o={},i=[];for(var s in _sections)o[s]=getSectionNavigableElements(s),i=i.concat(o[s]);var a=extend({},GlobalConfig,_sections[n]),c=void 0,u=void 0;if("self-only"===a.restrict||"self-first"===a.restrict){var l=o[n];u=exclude(l,t),(c=navigate(t,e,u,a))||"self-first"!==a.restrict||(u=exclude(i,l),c=navigate(t,e,u,a))}else u=exclude(i,t),c=navigate(t,e,u,a);if(c){_sections[n].previous={target:t,destination:c,reverse:REVERSE[e]};var f=getSectionId(c);if(n!==f){var d=gotoLeaveFor(n,e);if(d)return!0;if(null===d)return fireNavigateFailed(t,e),!1;var v=void 0;switch(_sections[f].enterTo){case"last-focused":v=getSectionLastFocusedElement(f)||getSectionDefaultElement(f);break;case"default-element":v=getSectionDefaultElement(f)}v&&(c=v)}return focusElement(c,f,e)}return!!gotoLeaveFor(n,e)||(fireNavigateFailed(t,e),!1)},preventDefault=function(e){return e.preventDefault(),e.stopPropagation(),!1},onMouseOver=function(e){var t=e.target;if(t&&(t.classList.contains("focusable")||t.closest(".focusable"))){var n=t.classList.contains("focusable")?t:t.closest(".focusable");return focusElement(n,getSectionId(n)),preventDefault(e)}},onMouseDown=function(e){var t=e.target;if(t&&(t.classList.contains("focusable")||t.closest(".focusable"))){var n=t.classList.contains("focusable")?t:t.closest(".focusable");return fireEvent(n,"enter-down")?void 0:preventDefault(e)}},onKeyDown=function(e){if(!(!_sectionCount||_pause||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=getCurrentFocusedElement(),n=getSectionId(t),r=KEYMAPPING[e.keyCode];if(r){if("enter"===r&&t&&n&&!fireEvent(t,"enter-down"))return preventDefault(e);if(!t&&(_lastSectionId&&(t=getSectionLastFocusedElement(_lastSectionId)),!t))return focusSection(),preventDefault(e);if(n)return fireEvent(t,"willmove",{direction:r,sectionId:n,cause:"keydown"})&&focusNext(r,t,n),preventDefault(e)}}},onKeyUp=function(e){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)&&!_pause&&_sectionCount&&"center"===KEYMAPPING[e.keyCode]){var t=getCurrentFocusedElement();t&&getSectionId(t)&&(fireEvent(t,"enter-up")||preventDefault(e))}},onFocus=function(e){var t=e.target;if(t!==window&&t!==document&&_sectionCount&&!_duringFocusChange){var n=getSectionId(t);if(n){if(_pause)return void focusChanged(t,n);var r={sectionId:n,native:!0};fireEvent(t,"willfocus",r)?(fireEvent(t,"focused",r,!1),focusChanged(t,n)):(_duringFocusChange=!0,t.blur(),_duringFocusChange=!1)}}},onBlur=function(e){var t=e.target;if(t!==window&&t!==document&&!_pause&&_sectionCount&&!_duringFocusChange&&getSectionId(t)){var n={native:!0};fireEvent(t,"willunfocus",n)?fireEvent(t,"unfocused",n,!1):(_duringFocusChange=!0,setTimeout(function(){t.focus(),_duringFocusChange=!1}))}},Navigation={init:function(){_ready||(window.addEventListener("mouseover",onMouseOver),window.addEventListener("mousedown",onMouseDown),window.addEventListener("keydown",onKeyDown),window.addEventListener("keyup",onKeyUp),window.addEventListener("focus",onFocus,!0),window.addEventListener("blur",onBlur,!0),_ready=!0)},uninit:function(){window.removeEventListener("mouseover",onMouseOver),window.removeEventListener("mousedown",onMouseDown),window.removeEventListener("blur",onBlur,!0),window.removeEventListener("focus",onFocus,!0),window.removeEventListener("keyup",onKeyUp),window.removeEventListener("keydown",onKeyDown),Navigation.clear(),_idPool=0,_ready=!1},clear:function(){_sections={},_sectionCount=0,_defaultSectionId="",_lastSectionId="",_duringFocusChange=!1},set:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=void 0,o=void 0;if("object"===_typeof(t[0]))o=t[0];else{if("string"!=typeof t[0]||"object"!==_typeof(t[1]))return;if(r=t[0],o=t[1],!_sections[r])throw new Error("Section "+r+" doesn't exist!")}for(var i in o)void 0!==GlobalConfig[i]&&(r?_sections[r][i]=o[i]:void 0!==o[i]&&(GlobalConfig[i]=o[i]))},add:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=void 0,o=void 0;if("object"===_typeof(t[0])?o=t[0]:"string"==typeof t[0]&&"object"===_typeof(t[1])&&(r=t[0],o=t[1]),r||(r="string"==typeof o.id?o.id:generateId()),_sections[r])throw new Error("Section "+r+" has already existed!");return _sections[r]={},_sectionCount++,Navigation.set(r,o),r},remove:function(e){if(!e||"string"!=typeof e)throw new Error('Please assign the "sectionId"!');return!!_sections[e]&&(_sections[e]=void 0,_sections=extend({},_sections),_sectionCount--,!0)},disable:function(e){return!!_sections[e]&&(_sections[e].disabled=!0,!0)},enable:function(e){return!!_sections[e]&&(_sections[e].disabled=!1,!0)},pause:function(){_pause=!0},resume:function(){_pause=!1},focus:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t[0],o=t[1];"boolean"==typeof r&&void 0===o&&(o=r,r=void 0);var i=!_pause&&o;i&&Navigation.pause();var s=void 0;if(r)if("string"==typeof r)s=_sections[r]?focusSection(r):focusExtendedSelector(r);else{var a=getSectionId(r);isNavigable(r,a)&&(s=focusElement(r,a))}else s=focusSection();return i&&Navigation.resume(),s},move:function(e,t){var n=e.toLowerCase();if(!REVERSE[n])return!1;var r=t?parseSelector(t)[0]:getCurrentFocusedElement();if(!r)return!1;var o=getSectionId(r);return!!o&&(!!fireEvent(r,"willmove",{direction:n,sectionId:o,cause:"api"})&&focusNext(n,r,o))},makeFocusable:function(e){var t=function(e){var t=e.tabIndexIgnoreList||GlobalConfig.tabIndexIgnoreList;parseSelector(e.selector).forEach(function(e){matchSelector(e,t)||e.getAttribute("tabindex")||e.setAttribute("tabindex","-1")})};if(e){if(!_sections[e])throw new Error("Section "+e+" doesn't exist!");t(_sections[e])}else for(var n in _sections)t(_sections[n])},setDefaultSection:function(e){if(e){if(!_sections[e])throw new Error("Section "+e+" doesn't exist!");_defaultSectionId=e}else _defaultSectionId=""},getSectionId:getSectionId};function _classCallCheck$1(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var TVNavigation=function e(){var t=this;_classCallCheck$1(this,e),this.init=function(){Navigation.init(),Navigation.focus(),t.bindFocusEvent()},this.destroy=function(){t.focusedPath=null,Navigation.uninit(),t.unbindFocusEvent()},this.bindFocusEvent=function(){t.listening||(t.listening=!0,document.addEventListener("sn:focused",t.handleFocused))},this.unbindFocusEvent=function(){document.removeEventListener("sn:focused",t.handleFocused),t.listening=!1},this.handleFocused=function(e){t.focusedPath!==e.detail.sectionId&&t.setCurrentFocusedPath(e.detail.sectionId)},this.getCurrentFocusedPath=function(){return t.focusedPath},this.setCurrentFocusedPath=function(e){t.focusedPath=e,Navigation.focus(e)},this.addEventListener=function(e,n,r){return document.querySelectorAll(e).forEach(function(e){return e.addEventListener(n,r)}),t},this.addFocusable=function(e,n){if(e&&!Navigation.getSectionId(document.getElementById(e.id))){t.removeFocusable(e);var r=Navigation.add(e);n&&t.addEventListener(e.selector,"sn:enter-down",n),Navigation.makeFocusable(r)}},this.removeFocusable=function(e){var t=Navigation.getSectionId(document.getElementById(e.id));t&&(Navigation.remove(t),document.querySelectorAll(e.selector).removeEventListener("sn:enter-down"))},this.destroy()},tvNavigation=new TVNavigation;export{tvNavigation as TVNavigation};
