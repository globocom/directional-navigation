!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.JSTVNavigation=t()}(this,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t={selector:"",straightOnly:!1,straightOverlapThreshold:.35,rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:[],navigableFilter:null},n={4:"left",21:"left",37:"left",214:"left",205:"left",218:"left",5:"right",22:"right",39:"right",213:"right",206:"right",217:"right",29460:"up",19:"up",38:"up",211:"up",203:"up",215:"up",29461:"down",20:"down",40:"down",212:"down",204:"down",216:"down",29443:"enter",13:"enter",67:"enter",32:"enter",23:"enter",195:"enter"},r={left:"right",up:"down",right:"left",down:"up"},o="sn:",i="section-",u=0,a=!1,s=!1,c={},f=0,l="",d="",v=!1,h=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||function(e){var t=(this.parentNode||this.document).querySelectorAll(e);return[].slice.call(t).indexOf(this)>=0};function p(e){var t=e.getBoundingClientRect(),n={left:t.left,top:t.top,right:t.right,bottom:t.bottom,width:t.width,height:t.height};return n.element=e,n.center={x:n.left+Math.floor(n.width/2),y:n.top+Math.floor(n.height/2)},n.center.left=n.center.right=n.center.x,n.center.top=n.center.bottom=n.center.y,n}function g(e,t,n){for(var r=[[],[],[],[],[],[],[],[],[]],o=0;o<e.length;o++){var i,u,a=e[o],s=a.center;if(i=s.x<t.left?0:s.x<=t.right?1:2,r[u=3*(s.y<t.top?0:s.y<=t.bottom?1:2)+i].push(a),-1!==[0,2,6,8].indexOf(u)){var c=n;a.left<=t.right-t.width*c&&(2===u?r[1].push(a):8===u&&r[7].push(a)),a.right>=t.left+t.width*c&&(0===u?r[1].push(a):6===u&&r[7].push(a)),a.top<=t.bottom-t.height*c&&(6===u?r[3].push(a):8===u&&r[5].push(a)),a.bottom>=t.top+t.height*c&&(0===u?r[3].push(a):2===u&&r[5].push(a))}}return r}function b(e,t,n,r){if(!(e&&t&&n&&n.length))return null;for(var o=[],i=0;i<n.length;i++){var u=p(n[i]);u&&o.push(u)}if(!o.length)return null;var a=p(e);if(!a)return null;var s,c=function(e){return{nearPlumbLineIsBetter:function(t){var n;return(n=t.center.x<e.center.x?e.center.x-t.right:t.left-e.center.x)<0?0:n},nearHorizonIsBetter:function(t){var n;return(n=t.center.y<e.center.y?e.center.y-t.bottom:t.top-e.center.y)<0?0:n},nearTargetLeftIsBetter:function(t){var n;return(n=t.center.x<e.center.x?e.left-t.right:t.left-e.left)<0?0:n},nearTargetTopIsBetter:function(t){var n;return(n=t.center.y<e.center.y?e.top-t.bottom:t.top-e.top)<0?0:n},topIsBetter:function(e){return e.top},bottomIsBetter:function(e){return-1*e.bottom},leftIsBetter:function(e){return e.left},rightIsBetter:function(e){return-1*e.right}}}(a),f=g(o,a,r.straightOverlapThreshold),l=g(f[4],a.center,r.straightOverlapThreshold);switch(t){case"left":s=[{group:l[0].concat(l[3]).concat(l[6]),distance:[c.nearPlumbLineIsBetter,c.topIsBetter]},{group:f[3],distance:[c.nearPlumbLineIsBetter,c.topIsBetter]},{group:f[0].concat(f[6]),distance:[c.nearHorizonIsBetter,c.rightIsBetter,c.nearTargetTopIsBetter]}];break;case"right":s=[{group:l[2].concat(l[5]).concat(l[8]),distance:[c.nearPlumbLineIsBetter,c.topIsBetter]},{group:f[5],distance:[c.nearPlumbLineIsBetter,c.topIsBetter]},{group:f[2].concat(f[8]),distance:[c.nearHorizonIsBetter,c.leftIsBetter,c.nearTargetTopIsBetter]}];break;case"up":s=[{group:l[0].concat(l[1]).concat(l[2]),distance:[c.nearHorizonIsBetter,c.leftIsBetter]},{group:f[1],distance:[c.nearHorizonIsBetter,c.leftIsBetter]},{group:f[0].concat(f[2]),distance:[c.nearPlumbLineIsBetter,c.bottomIsBetter,c.nearTargetLeftIsBetter]}];break;case"down":s=[{group:l[6].concat(l[7]).concat(l[8]),distance:[c.nearHorizonIsBetter,c.leftIsBetter]},{group:f[7],distance:[c.nearHorizonIsBetter,c.leftIsBetter]},{group:f[6].concat(f[8]),distance:[c.nearPlumbLineIsBetter,c.topIsBetter,c.nearTargetLeftIsBetter]}];break;default:return null}r.straightOnly&&s.pop();var d=function(e){for(var t=null,n=0;n<e.length;n++)if(e[n].group.length){t=e[n];break}if(!t)return null;var r=t.distance;return t.group.sort(function(e,t){for(var n=0;n<r.length;n++){var o=r[n],i=o(e)-o(t);if(i)return i}return 0}),t.group}(s);if(!d)return null;var v=null;if(r.rememberSource&&r.previous&&r.previous.destination===e&&r.previous.reverse===t)for(var h=0;h<d.length;h++)if(d[h].element===r.previous.target){v=d[h].element;break}return v||(v=d[0].element),v}function m(t){return"string"==typeof t?[].slice.call(document.querySelectorAll(t)):"object"===(void 0===t?"undefined":e(t))&&t.length?[].slice.call(t):"object"===(void 0===t?"undefined":e(t))&&1===t.nodeType?[t]:[]}function y(t,n){return"string"==typeof n?h.call(t,n):"object"===(void 0===n?"undefined":e(n))&&n.length?n.indexOf(t)>=0:"object"===(void 0===n?"undefined":e(n))&&1===n.nodeType&&t===n}function w(){var e=document.activeElement;if(e&&e!==document.body)return e}function I(e){e=e||{};for(var t=1;t<arguments.length;t++)if(arguments[t])for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&void 0!==arguments[t][n]&&(e[n]=arguments[t][n]);return e}function E(e,t){Array.isArray(t)||(t=[t]);for(var n,r=0;r<t.length;r++)(n=e.indexOf(t[r]))>=0&&e.splice(n,1);return e}function B(e,n,r){if(!e||!n||!c[n]||c[n].disabled)return!1;if(e.offsetWidth<=0&&e.offsetHeight<=0||e.hasAttribute("disabled"))return!1;if(r&&!y(e,c[n].selector))return!1;if("function"==typeof c[n].navigableFilter){if(!1===c[n].navigableFilter(e,n))return!1}else if("function"==typeof t.navigableFilter&&!1===t.navigableFilter(e,n))return!1;return!0}function x(e){for(var t in c)if(!c[t].disabled&&y(e,c[t].selector))return t}function F(e){return m(c[e].selector).filter(function(t){return B(t,e)})}function L(e){var t=c[e].defaultElement;return t?("string"==typeof t&&(t=m(t)[0]),B(t,e,!0)?t:null):null}function S(e){var t=c[e]&&c[e].lastFocusedElement;return B(t,e,!0)?t:null}function k(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];console.log("[fireEvent] type: ",t,", cancelable: ",r);var i=document.createEvent("CustomEvent");return i.initCustomEvent(o+t,!0,r,n),e.dispatchEvent(i)}function T(e,t,n){if(!e)return!1;var r=w(),o=function(){r&&r.blur(),e.focus(),P(e,t)};if(v)return o(),!0;if(v=!0,s)return o(),v=!1,!0;if(r){var i={nextElement:e,nextSectionId:t,direction:n,native:!1};if(!k(r,"willunfocus",i))return v=!1,!1;r.blur(),k(r,"unfocused",i,!1)}var u={previousElement:r,sectionId:t,direction:n,native:!1};return k(e,"willfocus",u)?(e.focus(),k(e,"focused",u,!1),v=!1,P(e,t),!0):(v=!1,!1)}function P(e,t){t||(t=x(e)),t&&(c[t].lastFocusedElement=e,d=t)}function O(e,t){if("@"==e.charAt(0)){return 1==e.length?N():N(e.substr(1))}else{var n=m(e)[0];if(n){var r=x(n);if(B(n,r))return T(n,r,t)}}return!1}function N(e){var t=[],n=function(e){e&&t.indexOf(e)<0&&c[e]&&!c[e].disabled&&t.push(e)};e?n(e):(n(l),n(d),Object.keys(c).map(n));for(var r=0;r<t.length;r++){var o,i=t[r];if(o="last-focused"==c[i].enterTo?S(i)||L(i)||F(i)[0]:L(i)||S(i)||F(i)[0])return T(o,i)}return!1}function C(e,t){k(e,"navigatefailed",{direction:t},!1)}function M(e,t){if(c[e].leaveFor&&void 0!==c[e].leaveFor[t]){var n=c[e].leaveFor[t];if("string"==typeof n)return""===n?null:O(n,t);var r=x(n);if(B(n,r))return T(n,r,t)}return!1}function j(e,n,o){var i=n.getAttribute("data-sn-"+e);if("string"==typeof i)return!(""===i||!O(i,e))||(C(n,e),!1);var u={},a=[];for(var s in c)u[s]=F(s),a=a.concat(u[s]);var f,l=I({},t,c[o]);if("self-only"==l.restrict||"self-first"==l.restrict){var d=u[o];(f=b(n,e,E(d,n),l))||"self-first"!=l.restrict||(f=b(n,e,E(a,d),l))}else f=b(n,e,E(a,n),l);if(f){c[o].previous={target:n,destination:f,reverse:r[e]};var v=x(f);if(o!=v){var h,p=M(o,e);if(p)return!0;if(null===p)return C(n,e),!1;switch(c[v].enterTo){case"last-focused":h=S(v)||L(v);break;case"default-element":h=L(v)}h&&(f=h)}return T(f,v,e)}return!!M(o,e)||(C(n,e),!1)}function H(e){if(!(!f||s||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=function(){return e.preventDefault(),e.stopPropagation(),!1},r=w(),o=x(r),i=n[e.keyCode];if(i){if("enter"==i&&r&&o&&!k(r,"enter-down"))return t();if(!r&&(d&&(r=S(d)),!r))return N(),t();if(o)return k(r,"willmove",{direction:i,sectionId:o,cause:"keydown"})&&j(i,r,o),t()}}}function A(e){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)&&!s&&f&&"center"==n[e.keyCode]){var t=w();t&&x(t)&&(k(t,"enter-up")||(e.preventDefault(),e.stopPropagation()))}}function z(e){var t=e.target;if(t!==window&&t!==document&&f&&!v){var n=x(t);if(n){if(s)return void P(t,n);var r={sectionId:n,native:!0};k(t,"willfocus",r)?(k(t,"focused",r,!1),P(t,n)):(v=!0,t.blur(),v=!1)}}}function D(e){var t=e.target;if(t!==window&&t!==document&&!s&&f&&!v&&x(t)){var n={native:!0};k(t,"willunfocus",n)?k(t,"unfocused",n,!1):(v=!0,setTimeout(function(){t.focus(),v=!1}))}}var K={init:function(){a||(window.addEventListener("keydown",H),window.addEventListener("keyup",A),window.addEventListener("focus",z,!0),window.addEventListener("blur",D,!0),a=!0)},uninit:function(){window.removeEventListener("blur",D,!0),window.removeEventListener("focus",z,!0),window.removeEventListener("keyup",A),window.removeEventListener("keydown",H),K.clear(),u=0,a=!1},clear:function(){c={},f=0,l="",d="",v=!1},set:function(){var n,r;if("object"===e(arguments[0]))r=arguments[0];else{if("string"!=typeof arguments[0]||"object"!==e(arguments[1]))return;if(n=arguments[0],r=arguments[1],!c[n])throw new Error('Section "'+n+"\" doesn't exist!")}for(var o in r)void 0!==t[o]&&(n?c[n][o]=r[o]:void 0!==r[o]&&(t[o]=r[o]));n&&(c[n]=I({},c[n]))},add:function(){var t,n={};if("object"===e(arguments[0])?n=arguments[0]:"string"==typeof arguments[0]&&"object"===e(arguments[1])&&(t=arguments[0],n=arguments[1]),t||(t="string"==typeof n.id?n.id:function(){for(var e;e=i+String(++u),c[e];);return e}()),c[t])throw new Error('Section "'+t+'" has already existed!');return c[t]={},f++,K.set(t,n),t},remove:function(e){if(!e||"string"!=typeof e)throw new Error('Please assign the "sectionId"!');return!!c[e]&&(c[e]=void 0,c=I({},c),f--,!0)},disable:function(e){return!!c[e]&&(c[e].disabled=!0,!0)},enable:function(e){return!!c[e]&&(c[e].disabled=!1,!0)},pause:function(){s=!0},resume:function(){s=!1},focus:function(e,t){var n=!1;void 0===t&&"boolean"==typeof e&&(t=e,e=void 0);var r=!s&&t;if(r&&K.pause(),e)if("string"==typeof e)n=c[e]?N(e):O(e);else{var o=x(e);B(e,o)&&(n=T(e,o))}else n=N();return r&&K.resume(),n},move:function(e,t){if(e=e.toLowerCase(),!r[e])return!1;var n=t?m(t)[0]:w();if(!n)return!1;var o=x(n);return!!o&&(!!k(n,"willmove",{direction:e,sectionId:o,cause:"api"})&&j(e,n,o))},makeFocusable:function(e){var n=function(e){var n=void 0!==e.tabIndexIgnoreList?e.tabIndexIgnoreList:t.tabIndexIgnoreList;m(e.selector).forEach(function(e){y(e,n)||e.getAttribute("tabindex")||e.setAttribute("tabindex","-1")})};if(e){if(!c[e])throw new Error('Section "'+e+"\" doesn't exist!");n(c[e])}else for(var r in c)n(c[r])},setDefaultSection:function(e){if(e){if(!c[e])throw new Error('Section "'+e+"\" doesn't exist!");l=e}else l=""},getSectionId:x},q=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return q(e,[{key:"chebyshevDistance",value:function(e,t,n,r,o){var i,u=-r;for(i=0;i<n;i+=1)u=o(u,Math.abs(e[i]-t[i]));return u}},{key:"minkowskiDistance",value:function(e,t,n,r,o){var i,u;if(t!==r)throw"Both vectors should have same dimension";if(isNaN(o))throw'The order "p" must be a number';if(o===Number.POSITIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.max);if(o===Number.NEGATIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.min);if(o<1)throw"Order less than 1 will violate the triangle inequality";for(i=0,u=0;u<t;u+=1)i+=Math.pow(Math.abs(e[u]-n[u]),o);return isNaN(i)?0:Math.pow(i,1/o)}},{key:"calculate",value:function(e,t,n){return this.minkowskiDistance(e,e.length,t,t.length,n)}}]),e}());return{SpatialNavigation:new function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.init=function(){K.init(),K.focus(),t.bindFocusEvent()},this.destroy=function(){t.focusedPath=null,K.uninit(),t.unbindFocusEvent()},this.bindFocusEvent=function(){t.listening||(t.listening=!0,document.addEventListener("sn:focused",t.handleFocused))},this.unbindFocusEvent=function(){document.removeEventListener("sn:focused",t.handleFocused),t.listening=!1},this.handleFocused=function(e){t.focusedPath!==e.detail.sectionId&&t.setCurrentFocusedPath(e.detail.sectionId)},this.getCurrentFocusedPath=function(){return t.focusedPath},this.setCurrentFocusedPath=function(e){console.log("setCurrentFocusedPath called."),t.focusedPath=e,K.focus(e)},this.addFocusable=function(e,n){var r=n.focusPath,o=n.onEnterPressHandler;if(e&&!K.getSectionId(e)){t.removeFocusable(e,{onEnterPressHandler:o});var i=[{selector:e}];r&&i.unshift(r),e.addEventListener("sn:enter-down",o);var u=K.add.apply(K,i);K.makeFocusable(u)}},this.removeFocusable=function(e,t){var n=t.onEnterPressHandler,r=K.getSectionId(e);r&&(K.remove(r),e.removeEventListener("sn:enter-down",n))},this.destroy()}}});
