!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).TVNavigation=t()}(this,(function(){"use strict";Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),n=t.length;--n>=0&&t.item(n)!==this;);return n>-1}),Element.prototype.closest||(Element.prototype.closest=function(e){var t=this;if(!document.documentElement.contains(t))return null;do{if(t.matches(e))return t;t=t.parentElement}while(null!==t);return null});var e=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var t=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}return e(t,null,[{key:"addListener",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if("string"==typeof e){var r=document.querySelectorAll(e);if(r&&r.length>0)for(var o=0;o<r.length;o++)r[o].addEventListener(t,n,i)}else e.addEventListener(t,n,i)}},{key:"removeListener",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if("string"==typeof e){var r=document.querySelectorAll(e);if(r&&r.length>0)for(var o=0;o<r.length;o++)r[o].removeEventListener(t,n,i)}else e.removeEventListener(t,n,i)}},{key:"fireEvent",value:function(e,t,n){var i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=document.createEvent("CustomEvent");return r.initCustomEvent(t,!0,i,n),e.dispatchEvent(r)}}]),t}(),n=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var i=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,[{key:"chebyshevDistance",value:function(e,t,n,i,r){var o=-i,s=void 0;for(s=0;s<n;s+=1)o=r(o,Math.abs(e[s]-t[s]));return o}},{key:"minkowskiDistance",value:function(e,t,n,i,r){var o=void 0,s=void 0;if(t!==i)throw new Error("Both vectors should have same dimension");if(isNaN(r))throw new Error('The order "p" must be a number');if(r===Number.POSITIVE_INFINITY)return this.chebyshevDistance(e,n,t,r,Math.max);if(r===Number.NEGATIVE_INFINITY)return this.chebyshevDistance(e,n,t,r,Math.min);if(r<1)throw new Error("Order less than 1 will violate the triangle inequality");for(o=0,s=0;s<t;s+=1)o+=Math.pow(Math.abs(e[s]-n[s]),r);return Math.pow(o,1/r)}},{key:"calculate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;return this.minkowskiDistance(e,e.length,t,t.length,n)}}]),e}()),r=function(e){var t=e.getBoundingClientRect(),n={left:t.left,top:t.top,right:t.right,bottom:t.bottom,width:t.width,height:t.height};return n.element=e,n.center={x:n.left+Math.floor(n.width/2),y:n.top+Math.floor(n.height/2)},n.center.left=n.center.x,n.center.right=n.center.x,n.center.top=n.center.y,n.center.bottom=n.center.y,n},o=function(e,t,n){var i,r,o,s=e.center,u=s.x,c=s.y,a=t.center,l=a.x,f=a.y,h=void 0,d=(i=f-c,r=l-u,o=Math.atan2(i,r),(o*=180/Math.PI)<0&&(o=360+o),o);switch(n){case"left":return d<=(h=60)/2||d>=360-h/2;case"right":return d>=180-(h=60)/2&&d<=180+h/2;case"up":return d>=90-(h=120)/2&&d<=90+h/2;case"down":return d>=270-(h=120)/2&&d<=270+h/2}},s={4:"left",21:"left",37:"left",214:"left",205:"left",218:"left",5:"right",22:"right",39:"right",213:"right",206:"right",217:"right",29460:"up",19:"up",38:"up",211:"up",203:"up",215:"up",29461:"down",20:"down",40:"down",212:"down",204:"down",216:"down",29443:"enter",13:"enter",67:"enter",32:"enter",23:"enter",195:"enter"},u=function(e){return s[e]},c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(e){return e.preventDefault(),e.stopPropagation(),!1},l=function(e){return"string"==typeof e?[].slice.call(document.querySelectorAll(e)):"object"===(void 0===e?"undefined":c(e))&&e.length?[].slice.call(e):"object"===(void 0===e?"undefined":c(e))&&1===e.nodeType?[e]:[]},f=function(e,t){return"string"==typeof t?e.matches(t):"object"===(void 0===t?"undefined":c(t))&&t.length?t.indexOf(e)>=0:"object"===(void 0===t?"undefined":c(t))&&1===t.nodeType&&e===t},h=function(e,t){var n=new Array(t);for(var i in n){var r=e.indexOf(i);r>=0&&e.splice(r,1)}return e},d=function(e){return{left:"right",up:"down",right:"left",down:"up"}[e]},v=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var s,u=e[Symbol.iterator]();!(i=(s=u.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{!i&&u.return&&u.return()}finally{if(r)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},y=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();return function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._onMouseOver=function(e){var t=e.target;if(t&&(t.classList.contains("focusable")||t.closest(".focusable"))){var i=t.classList.contains("focusable")?t:t.closest(".focusable");return n._focusElement(i,n._getSectionId(i)),a(e)}},this._onMouseClickOrDown=function(e){var t=e.target;if(t&&(t.classList.contains("focusable")||t.closest(".focusable"))){var i=t.classList.contains("focusable")?t:t.closest(".focusable");return n.fireEvent(i,"enter-down")?void 0:a(e)}},this._onKeyDown=function(e){if(!(!n._sectionCount||n._pause||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=n._getCurrentFocusedElement(),i=n._getSectionId(t),r=u(e.keyCode);if(r){if("enter"===r&&t&&i&&!n.fireEvent(t,"enter-down"))return a(e);if(!t){if(n._lastSectionId&&(t=n._getSectionLastFocusedElement(n._lastSectionId)),!t)return n._focusSection(),a(e);n.focus(t)}if(i=n._getSectionId(t)){var o={direction:r,sectionId:i,cause:"keydown"};return n.fireEvent(t,"willmove",o)&&n._focusNext(r,t,i),a(e)}}}},this._onKeyUp=function(e){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)&&!n._pause&&n._sectionCount&&"center"===u(e.keyCode)){var t=n._getCurrentFocusedElement();t&&n._getSectionId(t)&&(n.fireEvent(t,"enter-up")||a(e))}},this._onFocus=function(e){var t=e.target;if(t!==window&&t!==document&&n._sectionCount&&!n._duringFocusChange){var i=n._getSectionId(t);if(i){if(n._pause)return void n._focusChanged(t,i);var r={sectionId:i,native:!0};n.fireEvent(t,"willfocus",r)?(n.fireEvent(t,"focused",r,!1),n._focusChanged(t,i)):(n._duringFocusChange=!0,t.blur(),n._duringFocusChange=!1)}}},this._onBlur=function(e){var t=e.target;if(t!==window&&t!==document&&!n._pause&&n._sectionCount&&!n._duringFocusChange&&n._getSectionId(t)){var i={native:!0};n.fireEvent(t,"willunfocus",i)?n.fireEvent(t,"unfocused",i,!1):(n._duringFocusChange=!0,setTimeout((function(){t.focus(),n._duringFocusChange=!1})))}},this._handleFocused=function(e){n._focusedPath!==e.detail.sectionId&&n.setCurrentFocusedPath(e.detail.sectionId)},this._config=g({selector:"",rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:[],navigableFilter:null,eventPrefix:"sn:",idPoolPrefix:"section-"},t),this._idPool=0,this._ready=!1,this._pause=!1,this._sections={},this._sectionCount=0,this._defaultSectionId="",this._lastSectionId="",this._duringFocusChange=!1,this._focusedPath=null}return y(e,[{key:"init",value:function(){this._ready||(this.bindEvents(),this._ready=!0),this.focus()}},{key:"destroy",value:function(){this.clear(),this.unbindEvents()}},{key:"clear",value:function(){this._ready=!1,this._sections={},this._sectionCount=0,this._idPool=0,this._defaultSectionId="",this._lastSectionId="",this._duringFocusChange=!1,this._focusedPath=null}},{key:"bindEvents",value:function(){this.addEventListener(window,"click",this._onMouseClickOrDown),this.addEventListener(window,"mouseover",this._onMouseOver),this.addEventListener(window,"mousedown",this._onMouseClickOrDown),this.addEventListener(window,"keydown",this._onKeyDown),this.addEventListener(window,"keyup",this._onKeyUp),this.addEventListener(window,"focus",this._onFocus,!0),this.addEventListener(window,"blur",this._onBlur,!0),this.addEventListener(document,this._config.eventPrefix+"focused",this._handleFocused)}},{key:"unbindEvents",value:function(){this.removeEventListener(window,"click",this._onMouseClickOrDown),this.removeEventListener(window,"mouseover",this._onMouseOver),this.removeEventListener(window,"mousedown",this._onMouseClickOrDown),this.removeEventListener(window,"keydown",this._onKeyDown),this.removeEventListener(window,"keyup",this._onKeyUp),this.removeEventListener(window,"focus",this._onFocus,!0),this.removeEventListener(window,"blur",this._onBlur,!0),this.removeEventListener(document,this._config.eventPrefix+"focused",this._handleFocused)}},{key:"set",value:function(){for(var e=void 0,t=void 0,n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];if("object"===_(i[0]))t=i[0];else{if("string"!=typeof i[0]||"object"!==_(i[1]))return;if(e=i[0],t=i[1],!this._sections[e])throw new Error("Section "+e+" doesn't exist!")}for(var o in t)void 0!==this._config[o]&&(e?this._sections[e][o]=t[o]:void 0!==t[o]&&(this._config[o]=t[o]))}},{key:"add",value:function(){for(var e=void 0,t=void 0,n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];if("object"===_(i[0])?t=i[0]:"string"==typeof i[0]&&"object"===_(i[1])&&(e=i[0],t=i[1]),e||(e="string"==typeof t.id?t.id:this._generateId()),this._sections[e])throw new Error("Section "+e+" has already existed!");return this._sections[e]={},this._sectionCount++,this.set(e,t),e}},{key:"remove",value:function(e){if(!e||"string"!=typeof e)throw new Error('Please assign the "sectionId"!');return!!this._sections[e]&&(this._sections[e]=void 0,this._sections=g({},this._sections),this._sectionCount--,!0)}},{key:"disable",value:function(e){return!!this._sections[e]&&(this._sections[e].disabled=!0,!0)}},{key:"enable",value:function(e){return!!this._sections[e]&&(this._sections[e].disabled=!1,!0)}},{key:"pause",value:function(){this._pause=!0}},{key:"resume",value:function(){this._pause=!1}},{key:"focus",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[1];"boolean"==typeof i&&void 0===r&&(r=i,i=void 0);var o=!this._pause&&r;o&&this.pause();var s=void 0;if(i)if("string"==typeof i)s=this._sections[i]?this._focusSection(i):this._focusExtendedSelector(i);else{var u=this._getSectionId(i);this._isNavigable(i,u)&&(s=this._focusElement(i,u))}else s=this._focusSection();return o&&this.resume(),s}},{key:"move",value:function(e,t){var n=e.toLowerCase();if(!d(n))return!1;var i=t?l(t)[0]:this._getCurrentFocusedElement();if(!i)return!1;var r=this._getSectionId(i);if(!r)return!1;var o={direction:n,sectionId:r,cause:"api"};return!!this.fireEvent(i,"willmove",o)&&this._focusNext(n,i,r)}},{key:"fireEvent",value:function(e,n,i){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=""+this._config.eventPrefix+n;return t.fireEvent(e,o,i,r)}},{key:"addFocusable",value:function(e,t){if(e&&!this._getSectionId(document.getElementById(e.id))){this.removeFocusable(e);var n=this.add(e);t&&this.addEventListener(e.selector,this._config.eventPrefix+"enter-down",t),this._makeFocusable(n)}}},{key:"removeFocusable",value:function(e,t){var n=this._getSectionId(document.getElementById(e.id));n&&(this.remove(n),t&&this.removeEventListener(this._config.eventPrefix+"enter-down",t))}},{key:"setDefaultSection",value:function(e){if(e){if(!this._sections[e])throw new Error("Section "+e+" doesn't exist!");this._defaultSectionId=e}else this._defaultSectionId=""}},{key:"getCurrentFocusedPath",value:function(){return this._focusedPath}},{key:"setCurrentFocusedPath",value:function(e){this._focusedPath=e,this.focus(e)}},{key:"addEventListener",value:function(e,n,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t.addListener(e,n,i,r)}},{key:"removeEventListener",value:function(e,n,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t.removeListener(e,n,i,r)}},{key:"_makeFocusable",value:function(e){var t=this,n=function(e){var n=e.tabIndexIgnoreList||t._config.tabIndexIgnoreList;l(e.selector).forEach((function(e){f(e,n)||e.getAttribute("tabindex")||e.setAttribute("tabindex","-1")}))};if(e){if(!this._sections[e])throw new Error("Section "+e+" doesn't exist!");n(this._sections[e])}else for(var i in this._sections)n(this._sections[i])}},{key:"_navigate",value:function(e,t,n,s){if(!(e&&t&&n&&n.length))return null;var u=r(e);if(!u)return null;var c=[];if(n.forEach((function(e){var t=r(e);t&&c.push(t)})),!c.length)return null;var a,l=(a=u,{nearestIsBetter:function(e){var t=[a.center.x,a.center.y];return i.calculate(t,[e.center.x,e.center.y])},nearPlumbLineIsBetter:function(e){var t=void 0;return(t=e.center.x<a.center.x?a.center.x-e.right:e.left-a.center.x)<0?0:t},nearHorizonIsBetter:function(e){var t=void 0;return(t=e.center.y<a.center.y?a.center.y-e.bottom:e.top-a.center.y)<0?0:t},nearTargetLeftIsBetter:function(e){var t=void 0;return(t=e.center.x<a.center.x?a.left-e.right:e.left-a.left)<0?0:t},nearTargetTopIsBetter:function(e){var t=void 0;return(t=e.center.y<a.center.y?a.top-e.bottom:e.top-a.top)<0?0:t},topIsBetter:function(e){return e.top},bottomIsBetter:function(e){return-1*e.bottom},leftIsBetter:function(e){return e.left},rightIsBetter:function(e){return-1*e.right}});c=c.filter((function(e){return e.element!==u.element&&o(e,u,t)}));var f=function(e){var t=e||{},n=t.group,i=t.distance;return n&&i&&n.sort((function(e,t){for(var n=0;n<i.length;n++){var r=i[n],o=r(e)-r(t);if(o)return o}return 0})),n}(function(e){return{left:{group:c,distance:[l.nearestIsBetter,l.nearHorizonIsBetter,l.topIsBetter]},right:{group:c,distance:[l.nearestIsBetter,l.nearHorizonIsBetter,l.topIsBetter]},up:{group:c,distance:[l.nearestIsBetter,l.nearHorizonIsBetter,l.leftIsBetter]},down:{group:c,distance:[l.nearestIsBetter,l.nearPlumbLineIsBetter,l.topIsBetter,l.nearTargetLeftIsBetter]}}[e]}(t));if(!f)return null;var h=void 0;if(s.rememberSource&&s.previous&&s.previous.destination===e&&s.previous.reverse===t)for(var d in f)if(d.element===s.previous.target){h=d.element;break}if(!h){if(0===f.length)return;h=f[0].element}return h}},{key:"_isNavigable",value:function(e,t,n){if(!e||!t||!this._sections[t]||this._sections[t].disabled)return!1;if(e.offsetWidth<=0&&e.offsetHeight<=0||e.hasAttribute("disabled"))return!1;if(n&&!f(e,this._sections[t].selector))return!1;if("function"==typeof this._sections[t].navigableFilter){if(!1===this._sections[t].navigableFilter(e,t))return!1}else if("function"==typeof this._config.navigableFilter&&!1===this._config.navigableFilter(e,t))return!1;return!0}},{key:"_focusNext",value:function(e,t,n){var i=t.getAttribute("data-sn-"+e);if("string"==typeof i)return!(""===i||!this._focusExtendedSelector(i,e))||(this._fireNavigateFailed(t,e),!1);var r={},o=[];for(var s in this._sections)r[s]=this._getSectionNavigableElements(s),o=o.concat(r[s]);var u=g({},this._config,this._sections[n]),c=void 0,a=void 0;if("self-only"===u.restrict||"self-first"===u.restrict){var l=r[n];a=h(l,t),(c=this._navigate(t,e,a,u))||"self-first"!==u.restrict||(a=h(o,l),c=this._navigate(t,e,a,u))}else a=h(o,t),c=this._navigate(t,e,a,u);if(c){this._sections[n].previous={target:t,destination:c,reverse:d(e)};var f=this._getSectionId(c);if(n!==f){var v=this._gotoLeaveFor(n,e);if(v)return!0;if(null===v)return this._fireNavigateFailed(t,e),!1;var _=void 0;switch(this._sections[f].enterTo){case"last-focused":_=this._getSectionLastFocusedElement(f)||this._getSectionDefaultElement(f);break;case"default-element":_=this._getSectionDefaultElement(f)}_&&(c=_)}return this._focusElement(c,f,e)}return!!this._gotoLeaveFor(n,e)||(this._fireNavigateFailed(t,e),!1)}},{key:"_focusChanged",value:function(e,t){var n=t||this._getSectionId(e);n&&(this._sections[n].lastFocusedElement=e,this._lastSectionId=n)}},{key:"_focusElement",value:function(e,t,n){var i=this;if(!e)return!1;var r=this._getCurrentFocusedElement(),o=function(){r&&r.blur(),e.focus(),i._focusChanged(e,t)};if(this._duringFocusChange)return o(),!0;if(this._duringFocusChange=!0,this._pause)return o(),this._duringFocusChange=!1,!0;if(r){var s={nextElement:e,nextSectionId:t,direction:n,native:!1};if(!this.fireEvent(r,"willunfocus",s))return this._duringFocusChange=!1,!1;r.blur(),this.fireEvent(r,"unfocused",s,!1)}var u={previousElement:r,sectionId:t,direction:n,native:!1};return this.fireEvent(e,"willfocus",u)?(e.focus(),this.fireEvent(e,"focused",u,!1),this._duringFocusChange=!1,this._focusChanged(e,t),!0):(this._duringFocusChange=!1,!1)}},{key:"_focusSection",value:function(e){var t=this,n=[],i=function(e){e&&n.indexOf(e)<0&&t._sections[e]&&!t._sections[e].disabled&&n.push(e)};e?i(e):(i(this._defaultSectionId),i(this._lastSectionId),Object.keys(this._sections).map(i));for(var r=0;r<n.length;r++){var o=n[r],s=void 0;if(s="last-focused"===this._sections[o].enterTo?this._getSectionLastFocusedElement(o)||this._getSectionDefaultElement(o)||this._getSectionNavigableElements(o)[0]:this._getSectionDefaultElement(o)||this._getSectionLastFocusedElement(o)||this._getSectionNavigableElements(o)[0])return this._focusElement(s,o)}return!1}},{key:"_focusExtendedSelector",value:function(e,t){if("@"===e.charAt(0)){if(1===e.length)return this._focusSection();var n=e.substr(1);return this._focusSection(n)}var i=l(e),r=v(i,1)[0];if(r){var o=this._getSectionId(r);if(this._isNavigable(r,o))return this._focusElement(r,o,t)}return!1}},{key:"_getSectionId",value:function(e){for(var t in this._sections)if(!this._sections[t].disabled&&e&&f(e,this._sections[t].selector))return t}},{key:"_getSectionNavigableElements",value:function(e){var t=this;return l(this._sections[e].selector).filter((function(n){return t._isNavigable(n,e)}))}},{key:"_getSectionDefaultElement",value:function(e){var t=this._sections[e].defaultElement;if(!t)return null;if("string"==typeof t){var n=l(t);t=v(n,1)[0]}return this._isNavigable(t,e,!0)?t:null}},{key:"_getSectionLastFocusedElement",value:function(e){var t=this._sections[e]&&this._sections[e].lastFocusedElement;return this._isNavigable(t,e,!0)?t:null}},{key:"_getCurrentFocusedElement",value:function(){var e=document.activeElement;if(e&&e!==document.body)return e}},{key:"_fireNavigateFailed",value:function(e,t){return this.fireEvent(e,"navigatefailed",{direction:t},!1)}},{key:"_gotoLeaveFor",value:function(e,t){if(this._sections[e].leaveFor&&void 0!==this._sections[e].leaveFor[t]){var n=this._sections[e].leaveFor[t];if("string"==typeof n)return""===n?null:this._focusExtendedSelector(n,t);var i=this._getSectionId(n);if(this._isNavigable(n,i))return this._focusElement(n,i,t)}return!1}},{key:"_generateId",value:function(){var e=void 0;do{e=this._config.idPoolPrefix+String(++this._idPool)}while(this._sections[e]);return e}}]),e}()}));
