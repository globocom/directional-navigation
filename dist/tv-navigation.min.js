!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).TVNavigation=t()}(this,(function(){"use strict";var e=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var t=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this._eventPrefix=e}return e(t,[{key:"addListener",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];"string"==typeof e&&document.querySelectorAll(e).forEach((function(e){return e.addEventListener(t,n,r)})),e.addEventListener(t,n,r)}},{key:"removeListener",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];"string"==typeof e&&document.querySelectorAll(e).forEach((function(e){return e.removeEventListener(t,n,r)})),e.removeEventListener(t,n,r)}},{key:"fireEvent",value:function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=document.createEvent("CustomEvent");return o.initCustomEvent(this._eventPrefix+t,!0,r,n),e.dispatchEvent(o)}}]),t}(),n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var r=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,[{key:"chebyshevDistance",value:function(e,t,n,r,o){var i=-r,s=void 0;for(s=0;s<n;s+=1)i=o(i,Math.abs(e[s]-t[s]));return i}},{key:"minkowskiDistance",value:function(e,t,n,r,o){var i=void 0,s=void 0;if(t!==r)throw new Error("Both vectors should have same dimension");if(isNaN(o))throw new Error('The order "p" must be a number');if(o===Number.POSITIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.max);if(o===Number.NEGATIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.min);if(o<1)throw new Error("Order less than 1 will violate the triangle inequality");for(i=0,s=0;s<t;s+=1)i+=Math.pow(Math.abs(e[s]-n[s]),o);return isNaN(i)?0:Math.pow(i,1/o)}},{key:"calculate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;return this.minkowskiDistance(e,e.length,t,t.length,n)}}]),e}()),o=function(e){var t=e.getBoundingClientRect(),n={left:t.left,top:t.top,right:t.right,bottom:t.bottom,width:t.width,height:t.height};return n.element=e,n.center={x:n.left+Math.floor(n.width/2),y:n.top+Math.floor(n.height/2)},n.center.left=n.center.x,n.center.right=n.center.x,n.center.top=n.center.y,n.center.bottom=n.center.y,n},i={4:"left",21:"left",37:"left",214:"left",205:"left",218:"left",5:"right",22:"right",39:"right",213:"right",206:"right",217:"right",29460:"up",19:"up",38:"up",211:"up",203:"up",215:"up",29461:"down",20:"down",40:"down",212:"down",204:"down",216:"down",29443:"enter",13:"enter",67:"enter",32:"enter",23:"enter",195:"enter"},s=function(e){return i[e]},a=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||function(e){var t=(this.parentNode||this.document).querySelectorAll(e);return[].slice.call(t).indexOf(this)>=0},c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function(e){return e.preventDefault(),e.stopPropagation(),!1},f=function(e){return"string"==typeof e?[].slice.call(document.querySelectorAll(e)):"object"===(void 0===e?"undefined":c(e))&&e.length?[].slice.call(e):"object"===(void 0===e?"undefined":c(e))&&1===e.nodeType?[e]:[]},l=function(e,t){return"string"==typeof t?a.call(e,t):"object"===(void 0===t?"undefined":c(t))&&t.length?t.indexOf(e)>=0:"object"===(void 0===t?"undefined":c(t))&&1===t.nodeType&&e===t},d=function(e,t){for(var n in Array.from(t)){var r=e.indexOf(n);r>=0&&e.splice(r,1)}return e},v=function(e){return{left:"right",up:"down",right:"left",down:"up"}[e]},_=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},g=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var m={selector:"",straightOnly:!1,straightOverlapThreshold:.35,rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:[],navigableFilter:null,eventPrefix:"sn:",idPoolPrefix:"section-"},y=function(){var e=this;this.init=function(){e._ready||(e.bindEvents(),e._ready=!0),e.focus()},this.destroy=function(){e.clear(),e.unbindEvents()},this.clear=function(){e._ready=!1,e._sections={},e._sectionCount=0,e._idPool=0,e._defaultSectionId="",e._lastSectionId="",e._duringFocusChange=!1,e._focusedPath=null},this.bindEvents=function(){e._eventsManager.addListener(window,"mouseover",e._onMouseOver),e._eventsManager.addListener(window,"mousedown",e._onMouseDown),e._eventsManager.addListener(window,"keydown",e._onKeyDown),e._eventsManager.addListener(window,"keyup",e._onKeyUp),e._eventsManager.addListener(window,"focus",e._onFocus,!0),e._eventsManager.addListener(window,"blur",e._onBlur,!0),e._eventsManager.addListener(document,e._config.eventPrefix+"focused",e._handleFocused)},this.unbindEvents=function(){e._eventsManager.removeListener(window,"mouseover",e._onMouseOver),e._eventsManager.removeListener(window,"mousedown",e._onMouseDown),e._eventsManager.removeListener(window,"keydown",e._onKeyDown),e._eventsManager.removeListener(window,"keyup",e._onKeyUp),e._eventsManager.removeListener(window,"focus",e._onFocus,!0),e._eventsManager.removeListener(window,"blur",e._onBlur,!0),e._eventsManager.removeListener(document,e._config.eventPrefix+"focused",e._handleFocused)},this.set=function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var o=void 0,i=void 0;if("object"===h(n[0]))i=n[0];else{if("string"!=typeof n[0]||"object"!==h(n[1]))return;if(o=n[0],i=n[1],!e._sections[o])throw new Error("Section "+o+" doesn't exist!")}for(var s in i)void 0!==e._config[s]&&(o?e._sections[o][s]=i[s]:void 0!==i[s]&&(e._config[s]=i[s]))},this.add=function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var o=void 0,i=void 0;if("object"===h(n[0])?i=n[0]:"string"==typeof n[0]&&"object"===h(n[1])&&(o=n[0],i=n[1]),o||(o="string"==typeof i.id?i.id:e._generateId()),e._sections[o])throw new Error("Section "+o+" has already existed!");return e._sections[o]={},e._sectionCount++,e.set(o,i),o},this.remove=function(t){if(!t||"string"!=typeof t)throw new Error('Please assign the "sectionId"!');return!!e._sections[t]&&(e._sections[t]=void 0,e._sections=g({},e._sections),e._sectionCount--,!0)},this.disable=function(t){return!!e._sections[t]&&(e._sections[t].disabled=!0,!0)},this.enable=function(t){return!!e._sections[t]&&(e._sections[t].disabled=!1,!0)},this.pause=function(){e._pause=!0},this.resume=function(){e._pause=!1},this.focus=function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var o=n[0],i=n[1];"boolean"==typeof o&&void 0===i&&(i=o,o=void 0);var s=!e._pause&&i;s&&e.pause();var a=void 0;if(o)if("string"==typeof o)a=e._sections[o]?e._focusSection(o):e._focusExtendedSelector(o);else{var c=e._getSectionId(o);e._isNavigable(o,c)&&(a=e._focusElement(o,c))}else a=e._focusSection();return s&&e.resume(),a},this.move=function(t,n){var r=t.toLowerCase();if(!v(r))return!1;var o=n?f(n)[0]:e._getCurrentFocusedElement();if(!o)return!1;var i=e._getSectionId(o);if(!i)return!1;var s={direction:r,sectionId:i,cause:"api"};return!!e._eventsManager.fireEvent(o,"willmove",s)&&e._focusNext(r,o,i)},this.addFocusable=function(t,n){if(t&&!e._getSectionId(document.getElementById(t.id))){e.removeFocusable(t);var r=e.add(t);n&&e._eventsManager.addListener(t.selector,e._config.eventPrefix+"enter-down",n),e._makeFocusable(r)}},this.removeFocusable=function(t,n){var r=e._getSectionId(document.getElementById(t.id));r&&(e.remove(r),n&&e._eventsManager.removeListener(e._config.eventPrefix+"enter-down",n))},this.setDefaultSection=function(t){if(t){if(!e._sections[t])throw new Error("Section "+t+" doesn't exist!");e._defaultSectionId=t}else e._defaultSectionId=""},this.getCurrentFocusedPath=function(){return e._focusedPath},this.setCurrentFocusedPath=function(t){e._focusedPath=t,e.focus(t)},this._makeFocusable=function(t){var n=function(t){var n=t.tabIndexIgnoreList||e._config.tabIndexIgnoreList;f(t.selector).forEach((function(e){l(e,n)||e.getAttribute("tabindex")||e.setAttribute("tabindex","-1")}))};if(t){if(!e._sections[t])throw new Error("Section "+t+" doesn't exist!");n(e._sections[t])}else for(var r in e._sections)n(e._sections[r])},this._navigate=function(e,t,n,i){if(!(e&&t&&n&&n.length))return null;var s=o(e);if(!s)return null;var a=[];if(n.forEach((function(e){var t=o(e);t&&a.push(t)})),!a.length)return null;var c,u=(c=s,{nearestIsBetter:function(e){var t=[c.center.x,c.center.y];return r.calculate(t,[e.center.x,e.center.y])},nearPlumbLineIsBetter:function(e){var t=void 0;return(t=e.center.x<c.center.x?c.center.x-e.right:e.left-c.center.x)<0?0:t},nearHorizonIsBetter:function(e){var t=void 0;return(t=e.center.y<c.center.y?c.center.y-e.bottom:e.top-c.center.y)<0?0:t},nearTargetLeftIsBetter:function(e){var t=void 0;return(t=e.center.x<c.center.x?c.left-e.right:e.left-c.left)<0?0:t},nearTargetTopIsBetter:function(e){var t=void 0;return(t=e.center.y<c.center.y?c.top-e.bottom:e.top-c.top)<0?0:t},topIsBetter:function(e){return e.top},bottomIsBetter:function(e){return-1*e.bottom},leftIsBetter:function(e){return e.left},rightIsBetter:function(e){return-1*e.right}}),f=void 0;switch(t){case"left":f=[{group:a=a.filter((function(e){return e.center.x<s.center.x})),distance:[u.nearHorizonIsBetter,u.nearestIsBetter,u.topIsBetter]}];break;case"right":f=[{group:a=a.filter((function(e){return e.center.x>s.center.x})),distance:[u.nearHorizonIsBetter,u.nearestIsBetter,u.topIsBetter]}];break;case"up":f=[{group:a=a.filter((function(e){return e.center.y<s.center.y})),distance:[u.nearestIsBetter,u.nearHorizonIsBetter,u.leftIsBetter]}];break;case"down":f=[{group:a=a.filter((function(e){return e.center.y>s.center.y})),distance:[u.nearestIsBetter,u.nearPlumbLineIsBetter,u.topIsBetter,u.nearTargetLeftIsBetter]}];break;default:return null}i.straightOnly&&f.pop();var l=function(e){for(var t=void 0,n=0;n<e.length;n++)if(e[n].group.length){t=e[n];break}if(!t)return null;var r=t.distance;return t.group.sort((function(e,t){for(var n=0;n<r.length;n++){var o=r[n],i=o(e)-o(t);if(i)return i}return 0})),t.group}(f);if(!l)return null;var d=void 0;if(i.rememberSource&&i.previous&&i.previous.destination===e&&i.previous.reverse===t)for(var v in l)if(v.element===i.previous.target){d=v.element;break}return d||(d=l[0].element),d},this._isNavigable=function(t,n,r){if(!t||!n||!e._sections[n]||e._sections[n].disabled)return!1;if(t.offsetWidth<=0&&t.offsetHeight<=0||t.hasAttribute("disabled"))return!1;if(r&&!l(t,e._sections[n].selector))return!1;if("function"==typeof e._sections[n].navigableFilter){if(!1===e._sections[n].navigableFilter(t,n))return!1}else if("function"==typeof e._config.navigableFilter&&!1===e._config.navigableFilter(t,n))return!1;return!0},this._focusNext=function(t,n,r){var o=n.getAttribute("data-sn-"+t);if("string"==typeof o)return!(""===o||!e._focusExtendedSelector(o,t))||(e._fireNavigateFailed(n,t),!1);var i={},s=[];for(var a in e._sections)i[a]=e._getSectionNavigableElements(a),s=s.concat(i[a]);var c=g({},e._config,e._sections[r]),u=void 0,f=void 0;if("self-only"===c.restrict||"self-first"===c.restrict){var l=i[r];f=d(l,n),(u=e._navigate(n,t,f,c))||"self-first"!==c.restrict||(f=d(s,l),u=e._navigate(n,t,f,c))}else f=d(s,n),u=e._navigate(n,t,f,c);if(u){e._sections[r].previous={target:n,destination:u,reverse:v(t)};var _=e._getSectionId(u);if(r!==_){var h=e._gotoLeaveFor(r,t);if(h)return!0;if(null===h)return e._fireNavigateFailed(n,t),!1;var m=void 0;switch(e._sections[_].enterTo){case"last-focused":m=e._getSectionLastFocusedElement(_)||e._getSectionDefaultElement(_);break;case"default-element":m=e._getSectionDefaultElement(_)}m&&(u=m)}return e._focusElement(u,_,t)}return!!e._gotoLeaveFor(r,t)||(e._fireNavigateFailed(n,t),!1)},this._focusChanged=function(t,n){var r=n||e._getSectionId(t);r&&(e._sections[r].lastFocusedElement=t,e._lastSectionId=r)},this._focusElement=function(t,n,r){if(!t)return!1;var o=e._getCurrentFocusedElement(),i=function(){o&&o.blur(),t.focus(),e._focusChanged(t,n)};if(e._duringFocusChange)return i(),!0;if(e._duringFocusChange=!0,e._pause)return i(),e._duringFocusChange=!1,!0;if(o){var s={nextElement:t,nextSectionId:n,direction:r,native:!1};if(!e._eventsManager.fireEvent(o,"willunfocus",s))return e._duringFocusChange=!1,!1;o.blur(),e._eventsManager.fireEvent(o,"unfocused",s,!1)}var a={previousElement:o,sectionId:n,direction:r,native:!1};return e._eventsManager.fireEvent(t,"willfocus",a)?(t.focus(),e._eventsManager.fireEvent(t,"focused",a,!1),e._duringFocusChange=!1,e.focusChanged(t,n),!0):(e._duringFocusChange=!1,!1)},this._focusSection=function(t){var n=[],r=function(t){t&&n.indexOf(t)<0&&e._sections[t]&&!e._sections[t].disabled&&n.push(t)};t?r(t):(r(e._defaultSectionId),r(e._lastSectionId),Object.keys(e._sections).map(r));for(var o=0;o<n.length;o++){var i=n[o],s=void 0;if(s="last-focused"===e._sections[i].enterTo?e._getSectionLastFocusedElement(i)||e._getSectionDefaultElement(i)||e._getSectionNavigableElements(i)[0]:e._getSectionDefaultElement(i)||e._getSectionLastFocusedElement(i)||e._getSectionNavigableElements(i)[0])return e._focusElement(s,i)}return!1},this._focusExtendedSelector=function(t,n){if("@"===t.charAt(0)){if(1===t.length)return e._focusSection();var r=t.substr(1);return e._focusSection(r)}var o=f(t),i=_(o,1)[0];if(i){var s=e._getSectionId(i);if(e._isNavigable(i,s))return e._focusElement(i,s,n)}return!1},this._getSectionId=function(t){for(var n in e._sections)if(!e._sections[n].disabled&&t&&l(t,e._sections[n].selector))return n},this._getSectionNavigableElements=function(t){return f(e._sections[t].selector).filter((function(n){return e._isNavigable(n,t)}))},this._getSectionDefaultElement=function(t){var n=e._sections[t].defaultElement;if(!n)return null;if("string"==typeof n){var r=f(n);n=_(r,1)[0]}return e._isNavigable(n,t,!0)?n:null},this._getSectionLastFocusedElement=function(t){var n=e._sections[t]&&e._sections[t].lastFocusedElement;return e._isNavigable(n,t,!0)?n:null},this._getCurrentFocusedElement=function(){var e=document.activeElement;if(e&&e!==document.body)return e},this._fireNavigateFailed=function(t,n){return e._eventsManager.fireEvent(t,"navigatefailed",{direction:n},!1)},this._gotoLeaveFor=function(t,n){if(e._sections[t].leaveFor&&void 0!==e._sections[t].leaveFor[n]){var r=e._sections[t].leaveFor[n];if("string"==typeof r)return""===r?null:e._focusExtendedSelector(r,n);var o=e._getSectionId(r);if(e._isNavigable(r,o))return e._focusElement(r,o,n)}return!1},this._generateId=function(){var t=void 0;do{t=e._config.idPoolPrefix+String(++e._idPool)}while(e._sections[t]);return t},this._onMouseOver=function(t){var n=t.target;if(n&&(n.classList.contains("focusable")||n.closest(".focusable"))){var r=n.classList.contains("focusable")?n:n.closest(".focusable");return e.focusElement(r,e._getSectionId(r)),u(t)}},this._onMouseDown=function(t){var n=t.target;if(n&&(n.classList.contains("focusable")||n.closest(".focusable"))){var r=n.classList.contains("focusable")?n:n.closest(".focusable");return e._eventsManager.fireEvent(r,"enter-down")?void 0:u(t)}},this._onKeyDown=function(t){if(!(!e._sectionCount||e._pause||t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)){var n=e._getCurrentFocusedElement(),r=e._getSectionId(n),o=s(t.keyCode);if(o){if("enter"===o&&n&&r&&!e._eventsManager.fireEvent(n,"enter-down"))return u(t);if(!n&&(e._lastSectionId&&(n=e._getSectionLastFocusedElement(e._lastSectionId)),!n))return e.focusSection(),u(t);if(r){var i={direction:o,sectionId:r,cause:"keydown"};return e._eventsManager.fireEvent(n,"willmove",i)&&e._focusNext(o,n,r),u(t)}}}},this._onKeyUp=function(t){if(!(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)&&!e._pause&&e._sectionCount&&"center"===s(t.keyCode)){var n=e._getCurrentFocusedElement();n&&e._getSectionId(n)&&(e._eventsManager.fireEvent(n,"enter-up")||u(t))}},this._onFocus=function(t){var n=t.target;if(n!==window&&n!==document&&e._sectionCount&&!e._duringFocusChange){var r=e._getSectionId(n);if(r){if(e._pause)return void e._focusChanged(n,r);var o={sectionId:r,native:!0};e._eventsManager.fireEvent(n,"willfocus",o)?(e._eventsManager.fireEvent(n,"focused",o,!1),e._focusChanged(n,r)):(e._duringFocusChange=!0,n.blur(),e._duringFocusChange=!1)}}},this._onBlur=function(t){var n=t.target;if(n!==window&&n!==document&&!e._pause&&e._sectionCount&&!e._duringFocusChange&&e._getSectionId(n)){var r={native:!0};e._eventsManager.fireEvent(n,"willunfocus",r)?e._eventsManager.fireEvent(n,"unfocused",r,!1):(e._duringFocusChange=!0,setTimeout((function(){n.focus(),e._duringFocusChange=!1})))}},this._handleFocused=function(t){e._focusedPath!==t.detail.sectionId&&e.setCurrentFocusedPath(t.detail.sectionId)}};return function e(n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),y.call(this),Object.assign(m,n),this._config=n,this._ready=!1,this._idPool=0,this._pause=!1,this._sections={},this._sectionCount=0,this._defaultSectionId="",this._lastSectionId="",this._duringFocusChange=!1,this._focusedPath=null,this._eventsManager=new t(this._config.eventPrefix)}}));
