!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).TVNavigation=t()}(this,(function(){"use strict";Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),n=t.length;--n>=0&&t.item(n)!==this;);return n>-1}),Element.prototype.closest||(Element.prototype.closest=function(e){var t=this;if(!document.documentElement.contains(t))return null;do{if(t.matches(e))return t;t=t.parentElement}while(null!==t);return null});var e=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var t=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}return e(t,null,[{key:"addListener",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if("string"==typeof e){var o=document.querySelectorAll(e);if(o&&o.length>0)for(var i=0;i<o.length;i++)o[i].addEventListener(t,n,r)}else e.addEventListener(t,n,r)}},{key:"removeListener",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if("string"==typeof e){var o=document.querySelectorAll(e);if(o&&o.length>0)for(var i=0;i<o.length;i++)o[i].removeEventListener(t,n,r)}else e.removeEventListener(t,n,r)}},{key:"fireEvent",value:function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=document.createEvent("CustomEvent");return o.initCustomEvent(t,!0,r,n),e.dispatchEvent(o)}}]),t}(),n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var r=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,[{key:"chebyshevDistance",value:function(e,t,n,r,o){var i=-r,u=void 0;for(u=0;u<n;u+=1)i=o(i,Math.abs(e[u]-t[u]));return i}},{key:"minkowskiDistance",value:function(e,t,n,r,o){var i=void 0,u=void 0;if(t!==r)throw new Error("Both vectors should have same dimension");if(isNaN(o))throw new Error('The order "p" must be a number');if(o===Number.POSITIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.max);if(o===Number.NEGATIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.min);if(o<1)throw new Error("Order less than 1 will violate the triangle inequality");for(i=0,u=0;u<t;u+=1)i+=Math.pow(Math.abs(e[u]-n[u]),o);return Math.pow(i,1/o)}},{key:"calculate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;return this.minkowskiDistance(e,e.length,t,t.length,n)}}]),e}()),o=function(e){var t=e.getBoundingClientRect(),n={left:t.left,top:t.top,right:t.right,bottom:t.bottom,width:t.width,height:t.height};return n.element=e,n.center={x:n.left+Math.floor(n.width/2),y:n.top+Math.floor(n.height/2)},n.center.left=n.center.x,n.center.right=n.center.x,n.center.top=n.center.y,n.center.bottom=n.center.y,n},i={4:"left",21:"left",37:"left",214:"left",205:"left",218:"left",5:"right",22:"right",39:"right",213:"right",206:"right",217:"right",29460:"up",19:"up",38:"up",211:"up",203:"up",215:"up",29461:"down",20:"down",40:"down",212:"down",204:"down",216:"down",29443:"enter",13:"enter",67:"enter",32:"enter",23:"enter",195:"enter"},u=function(e){return i[e]},a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=function(e){return e.preventDefault(),e.stopPropagation(),!1},s=function(e){return"string"==typeof e?[].slice.call(document.querySelectorAll(e)):"object"===(void 0===e?"undefined":a(e))&&e.length?[].slice.call(e):"object"===(void 0===e?"undefined":a(e))&&1===e.nodeType?[e]:[]},l=function(e,t){return"string"==typeof t?e.matches(t):"object"===(void 0===t?"undefined":a(t))&&t.length?t.indexOf(e)>=0:"object"===(void 0===t?"undefined":a(t))&&1===t.nodeType&&e===t},f=function(e,t){var n=new Array(t);for(var r in n){var o=e.indexOf(r);o>=0&&e.splice(o,1)}return e},v=function(e){return{left:"right",up:"down",right:"left",down:"up"}[e]},d=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var u,a=e[Symbol.iterator]();!(r=(u=a.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},h=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var m={selector:"",straightOnly:!1,straightOverlapThreshold:.35,rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:[],navigableFilter:null,eventPrefix:"sn:",idPoolPrefix:"section-"},b=0,p=!1,E=!1,w={},_=0,k="",S="",I=!1,x=null;return function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t&&(m=Object.assign(m,t))}return g(e,[{key:"init",value:function(){p||(this.bindEvents(),p=!0),e.focus()}},{key:"destroy",value:function(){this.clear(),this.unbindEvents()}},{key:"clear",value:function(){p=!1,w={},_=0,b=0,k="",S="",I=!1,x=null}},{key:"bindEvents",value:function(){this.addEventListener(window,"click",this._onMouseClickOrDown),this.addEventListener(window,"mouseover",this._onMouseOver),this.addEventListener(window,"mousedown",this._onMouseClickOrDown),this.addEventListener(window,"keydown",this._onKeyDown),this.addEventListener(window,"keyup",this._onKeyUp),this.addEventListener(window,"focus",this._onFocus,!0),this.addEventListener(window,"blur",this._onBlur,!0),this.addEventListener(document,m.eventPrefix+"focused",this._handleFocused)}},{key:"unbindEvents",value:function(){this.removeEventListener(window,"click",this._onMouseClickOrDown),this.removeEventListener(window,"mouseover",this._onMouseOver),this.removeEventListener(window,"mousedown",this._onMouseClickOrDown),this.removeEventListener(window,"keydown",this._onKeyDown),this.removeEventListener(window,"keyup",this._onKeyUp),this.removeEventListener(window,"focus",this._onFocus,!0),this.removeEventListener(window,"blur",this._onBlur,!0),this.removeEventListener(document,m.eventPrefix+"focused",this._handleFocused)}},{key:"addFocusable",value:function(t,n){if(t&&!e._getSectionId(document.getElementById(t.id))){this.removeFocusable(t);var r=e.add(t);n&&this.addEventListener(t.selector,m.eventPrefix+"enter-down",n),this._makeFocusable(r)}}},{key:"removeFocusable",value:function(t,n){var r=e._getSectionId(document.getElementById(t.id));r&&(this.remove(r),n&&this.removeEventListener(m.eventPrefix+"enter-down",n))}},{key:"setDefaultSection",value:function(e){if(e){if(!w[e])throw new Error("Section "+e+" doesn't exist!");k=e}else k=""}},{key:"getCurrentFocusedPath",value:function(){return x}},{key:"setCurrentFocusedPath",value:function(t){x=t,e.focus(t)}},{key:"addEventListener",value:function(e,n,r){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t.addListener(e,n,r,o)}},{key:"removeEventListener",value:function(e,n,r){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t.removeListener(e,n,r,o)}},{key:"_makeFocusable",value:function(e){var t=function(e){var t=e.tabIndexIgnoreList||m.tabIndexIgnoreList;s(e.selector).forEach((function(e){l(e,t)||e.getAttribute("tabindex")||e.setAttribute("tabindex","-1")}))};if(e){if(!w[e])throw new Error("Section "+e+" doesn't exist!");t(w[e])}else for(var n in w)t(w[n])}},{key:"_onMouseOver",value:function(t){var n=t.target;if(n&&(n.classList.contains("focusable")||n.closest(".focusable"))){var r=n.classList.contains("focusable")?n:n.closest(".focusable");return e._focusElement(r,e._getSectionId(r)),c(t)}}},{key:"_onMouseClickOrDown",value:function(t){var n=t.target;if(n&&(n.classList.contains("focusable")||n.closest(".focusable"))){var r=n.classList.contains("focusable")?n:n.closest(".focusable");return e.fireEvent(r,"enter-down")?void 0:c(t)}}},{key:"_onKeyDown",value:function(t){if(!(!_||E||t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)){var n=e._getCurrentFocusedElement(),r=e._getSectionId(n),o=u(t.keyCode);if(o){if("enter"===o&&n&&r&&!e.fireEvent(n,"enter-down"))return c(t);if(!n&&(S&&(n=e._getSectionLastFocusedElement(S)),!n))return this.focusSection(),c(t);if(r){var i={direction:o,sectionId:r,cause:"keydown"};return e.fireEvent(n,"willmove",i)&&e._focusNext(o,n,r),c(t)}}}}},{key:"_onKeyUp",value:function(t){if(!(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)&&!E&&_&&"center"===u(t.keyCode)){var n=e._getCurrentFocusedElement();n&&e._getSectionId(n)&&(e.fireEvent(n,"enter-up")||c(t))}}},{key:"_onFocus",value:function(t){var n=t.target;if(n!==window&&n!==document&&_&&!I){var r=e._getSectionId(n);if(r){if(E)return void e._focusChanged(n,r);var o={sectionId:r,native:!0};e.fireEvent(n,"willfocus",o)?(e.fireEvent(n,"focused",o,!1),e._focusChanged(n,r)):(I=!0,n.blur(),I=!1)}}}},{key:"_onBlur",value:function(t){var n=t.target;if(n!==window&&n!==document&&!E&&_&&!I&&e._getSectionId(n)){var r={native:!0};e.fireEvent(n,"willunfocus",r)?e.fireEvent(n,"unfocused",r,!1):(I=!0,setTimeout((function(){n.focus(),I=!1})))}}},{key:"_handleFocused",value:function(e){x!==e.detail.sectionId&&this.setCurrentFocusedPath(e.detail.sectionId)}}],[{key:"set",value:function(){for(var e=void 0,t=void 0,n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];if("object"===y(r[0]))t=r[0];else{if("string"!=typeof r[0]||"object"!==y(r[1]))return;if(e=r[0],t=r[1],!w[e])throw new Error("Section "+e+" doesn't exist!")}for(var i in t)void 0!==m[i]&&(e?w[e][i]=t[i]:void 0!==t[i]&&(m[i]=t[i]))}},{key:"add",value:function(){for(var t=void 0,n=void 0,r=arguments.length,o=Array(r),i=0;i<r;i++)o[i]=arguments[i];if("object"===y(o[0])?n=o[0]:"string"==typeof o[0]&&"object"===y(o[1])&&(t=o[0],n=o[1]),t||(t="string"==typeof n.id?n.id:e._generateId()),w[t])throw new Error("Section "+t+" has already existed!");return w[t]={},_++,e.set(t,n),t}},{key:"remove",value:function(e){if(!e||"string"!=typeof e)throw new Error('Please assign the "sectionId"!');return!!w[e]&&(w[e]=void 0,w=h({},w),_--,!0)}},{key:"disable",value:function(e){return!!w[e]&&(w[e].disabled=!0,!0)}},{key:"enable",value:function(e){return!!w[e]&&(w[e].disabled=!1,!0)}},{key:"pause",value:function(){E=!0}},{key:"resume",value:function(){E=!1}},{key:"focus",value:function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var o=n[0],i=n[1];"boolean"==typeof o&&void 0===i&&(i=o,o=void 0);var u=!E&&i;u&&e.pause();var a=void 0;if(o)if("string"==typeof o)a=w[o]?e._focusSection(o):e._focusExtendedSelector(o);else{var c=e._getSectionId(o);e._isNavigable(o,c)&&(a=e._focusElement(o,c))}else a=e._focusSection();return u&&e.resume(),a}},{key:"move",value:function(t,n){var r=t.toLowerCase();if(!v(r))return!1;var o=n?s(n)[0]:e._getCurrentFocusedElement();if(!o)return!1;var i=e._getSectionId(o);if(!i)return!1;var u={direction:r,sectionId:i,cause:"api"};return!!e.fireEvent(o,"willmove",u)&&e._focusNext(r,o,i)}},{key:"fireEvent",value:function(e,n,r){var o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=""+m.eventPrefix+n;return t.fireEvent(e,i,r,o)}},{key:"_navigate",value:function(e,t,n,i){if(!(e&&t&&n&&n.length))return null;var u=o(e);if(!u)return null;var a=[];if(n.forEach((function(e){var t=o(e);t&&a.push(t)})),!a.length)return null;var c,s=(c=u,{nearestIsBetter:function(e){var t=[c.center.x,c.center.y];return r.calculate(t,[e.center.x,e.center.y])},nearPlumbLineIsBetter:function(e){var t=void 0;return(t=e.center.x<c.center.x?c.center.x-e.right:e.left-c.center.x)<0?0:t},nearHorizonIsBetter:function(e){var t=void 0;return(t=e.center.y<c.center.y?c.center.y-e.bottom:e.top-c.center.y)<0?0:t},nearTargetLeftIsBetter:function(e){var t=void 0;return(t=e.center.x<c.center.x?c.left-e.right:e.left-c.left)<0?0:t},nearTargetTopIsBetter:function(e){var t=void 0;return(t=e.center.y<c.center.y?c.top-e.bottom:e.top-c.top)<0?0:t},topIsBetter:function(e){return e.top},bottomIsBetter:function(e){return-1*e.bottom},leftIsBetter:function(e){return e.left},rightIsBetter:function(e){return-1*e.right}}),l=void 0;switch(t){case"left":l=[{group:a=a.filter((function(e){return e.center.x<u.center.x})),distance:[s.nearHorizonIsBetter,s.nearestIsBetter,s.topIsBetter]}];break;case"right":l=[{group:a=a.filter((function(e){return e.center.x>u.center.x})),distance:[s.nearHorizonIsBetter,s.nearestIsBetter,s.topIsBetter]}];break;case"up":l=[{group:a=a.filter((function(e){return e.center.y<u.center.y})),distance:[s.nearestIsBetter,s.nearHorizonIsBetter,s.leftIsBetter]}];break;case"down":l=[{group:a=a.filter((function(e){return e.center.y>u.center.y})),distance:[s.nearestIsBetter,s.nearPlumbLineIsBetter,s.topIsBetter,s.nearTargetLeftIsBetter]}];break;default:return null}i.straightOnly&&l.pop();var f=function(e){for(var t=void 0,n=0;n<e.length;n++)if(e[n].group.length){t=e[n];break}if(!t)return null;var r=t.distance;return t.group.sort((function(e,t){for(var n=0;n<r.length;n++){var o=r[n],i=o(e)-o(t);if(i)return i}return 0})),t.group}(l);if(!f)return null;var v=void 0;if(i.rememberSource&&i.previous&&i.previous.destination===e&&i.previous.reverse===t)for(var d in f)if(d.element===i.previous.target){v=d.element;break}return v||(v=f[0].element),v}},{key:"_isNavigable",value:function(e,t,n){if(!e||!t||!w[t]||w[t].disabled)return!1;if(e.offsetWidth<=0&&e.offsetHeight<=0||e.hasAttribute("disabled"))return!1;if(n&&!l(e,w[t].selector))return!1;if("function"==typeof w[t].navigableFilter){if(!1===w[t].navigableFilter(e,t))return!1}else if("function"==typeof m.navigableFilter&&!1===m.navigableFilter(e,t))return!1;return!0}},{key:"_focusNext",value:function(t,n,r){var o=n.getAttribute("data-sn-"+t);if("string"==typeof o)return!(""===o||!e._focusExtendedSelector(o,t))||(e._fireNavigateFailed(n,t),!1);var i={},u=[];for(var a in w)i[a]=e._getSectionNavigableElements(a),u=u.concat(i[a]);var c=h({},m,w[r]),s=void 0,l=void 0;if("self-only"===c.restrict||"self-first"===c.restrict){var d=i[r];l=f(d,n),(s=e._navigate(n,t,l,c))||"self-first"!==c.restrict||(l=f(u,d),s=e._navigate(n,t,l,c))}else l=f(u,n),s=e._navigate(n,t,l,c);if(s){w[r].previous={target:n,destination:s,reverse:v(t)};var y=e._getSectionId(s);if(r!==y){var g=e._gotoLeaveFor(r,t);if(g)return!0;if(null===g)return e._fireNavigateFailed(n,t),!1;var b=void 0;switch(w[y].enterTo){case"last-focused":b=e._getSectionLastFocusedElement(y)||e._getSectionDefaultElement(y);break;case"default-element":b=e._getSectionDefaultElement(y)}b&&(s=b)}return e._focusElement(s,y,t)}return!!e._gotoLeaveFor(r,t)||(e._fireNavigateFailed(n,t),!1)}},{key:"_focusChanged",value:function(t,n){var r=n||e._getSectionId(t);r&&(w[r].lastFocusedElement=t,S=r)}},{key:"_focusElement",value:function(t,n,r){if(!t)return!1;var o=e._getCurrentFocusedElement(),i=function(){o&&o.blur(),t.focus(),e._focusChanged(t,n)};if(I)return i(),!0;if(I=!0,E)return i(),I=!1,!0;if(o){var u={nextElement:t,nextSectionId:n,direction:r,native:!1};if(!e.fireEvent(o,"willunfocus",u))return I=!1,!1;o.blur(),e.fireEvent(o,"unfocused",u,!1)}var a={previousElement:o,sectionId:n,direction:r,native:!1};return e.fireEvent(t,"willfocus",a)?(t.focus(),e.fireEvent(t,"focused",a,!1),I=!1,e._focusChanged(t,n),!0):(I=!1,!1)}},{key:"_focusSection",value:function(t){var n=[],r=function(e){e&&n.indexOf(e)<0&&w[e]&&!w[e].disabled&&n.push(e)};t?r(t):(r(k),r(S),Object.keys(w).map(r));for(var o=0;o<n.length;o++){var i=n[o],u=void 0;if(u="last-focused"===w[i].enterTo?e._getSectionLastFocusedElement(i)||e._getSectionDefaultElement(i)||e._getSectionNavigableElements(i)[0]:e._getSectionDefaultElement(i)||e._getSectionLastFocusedElement(i)||e._getSectionNavigableElements(i)[0])return e._focusElement(u,i)}return!1}},{key:"_focusExtendedSelector",value:function(t,n){if("@"===t.charAt(0)){if(1===t.length)return e._focusSection();var r=t.substr(1);return e._focusSection(r)}var o=s(t),i=d(o,1)[0];if(i){var u=e._getSectionId(i);if(e._isNavigable(i,u))return e._focusElement(i,u,n)}return!1}},{key:"_getSectionId",value:function(e){for(var t in w)if(!w[t].disabled&&e&&l(e,w[t].selector))return t}},{key:"_getSectionNavigableElements",value:function(t){return s(w[t].selector).filter((function(n){return e._isNavigable(n,t)}))}},{key:"_getSectionDefaultElement",value:function(t){var n=w[t].defaultElement;if(!n)return null;if("string"==typeof n){var r=s(n);n=d(r,1)[0]}return e._isNavigable(n,t,!0)?n:null}},{key:"_getSectionLastFocusedElement",value:function(t){var n=w[t]&&w[t].lastFocusedElement;return e._isNavigable(n,t,!0)?n:null}},{key:"_getCurrentFocusedElement",value:function(){var e=document.activeElement;if(e&&e!==document.body)return e}},{key:"_fireNavigateFailed",value:function(t,n){return e.fireEvent(t,"navigatefailed",{direction:n},!1)}},{key:"_gotoLeaveFor",value:function(t,n){if(w[t].leaveFor&&void 0!==w[t].leaveFor[n]){var r=w[t].leaveFor[n];if("string"==typeof r)return""===r?null:e._focusExtendedSelector(r,n);var o=e._getSectionId(r);if(e._isNavigable(r,o))return e._focusElement(r,o,n)}return!1}},{key:"_generateId",value:function(){var e=void 0;do{e=m.idPoolPrefix+String(++b)}while(w[e]);return e}}]),e}()}));
