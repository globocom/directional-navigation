!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).TVNavigation=t()}(this,(function(){"use strict";var e=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var t=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}return e(t,null,[{key:"addListener",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if("string"==typeof e){var o=document.querySelectorAll(e);if(o&&o.length>0)for(var i=0;i<o.length;i++)o[i].addEventListener(t,n,r)}else e.addEventListener(t,n,r)}},{key:"removeListener",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if("string"==typeof e){var o=document.querySelectorAll(e);if(o&&o.length>0)for(var i=0;i<o.length;i++)o[i].removeEventListener(t,n,r)}else e.removeEventListener(t,n,r)}},{key:"fireEvent",value:function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=document.createEvent("CustomEvent");return o.initCustomEvent(t,!0,r,n),e.dispatchEvent(o)}}]),t}(),n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var r=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,[{key:"chebyshevDistance",value:function(e,t,n,r,o){var i=-r,u=void 0;for(u=0;u<n;u+=1)i=o(i,Math.abs(e[u]-t[u]));return i}},{key:"minkowskiDistance",value:function(e,t,n,r,o){var i=void 0,u=void 0;if(t!==r)throw new Error("Both vectors should have same dimension");if(isNaN(o))throw new Error('The order "p" must be a number');if(o===Number.POSITIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.max);if(o===Number.NEGATIVE_INFINITY)return this.chebyshevDistance(e,n,t,o,Math.min);if(o<1)throw new Error("Order less than 1 will violate the triangle inequality");for(i=0,u=0;u<t;u+=1)i+=Math.pow(Math.abs(e[u]-n[u]),o);return isNaN(i)?0:Math.pow(i,1/o)}},{key:"calculate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;return this.minkowskiDistance(e,e.length,t,t.length,n)}}]),e}()),o=function(e){var t=e.getBoundingClientRect(),n={left:t.left,top:t.top,right:t.right,bottom:t.bottom,width:t.width,height:t.height};return n.element=e,n.center={x:n.left+Math.floor(n.width/2),y:n.top+Math.floor(n.height/2)},n.center.left=n.center.x,n.center.right=n.center.x,n.center.top=n.center.y,n.center.bottom=n.center.y,n},i={4:"left",21:"left",37:"left",214:"left",205:"left",218:"left",5:"right",22:"right",39:"right",213:"right",206:"right",217:"right",29460:"up",19:"up",38:"up",211:"up",203:"up",215:"up",29461:"down",20:"down",40:"down",212:"down",204:"down",216:"down",29443:"enter",13:"enter",67:"enter",32:"enter",23:"enter",195:"enter"},u=function(e){return i[e]},a=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||function(e){var t=(this.parentNode||this.document).querySelectorAll(e);return[].slice.call(t).indexOf(this)>=0},s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=function(e){return e.preventDefault(),e.stopPropagation(),!1},l=function(e){return"string"==typeof e?[].slice.call(document.querySelectorAll(e)):"object"===(void 0===e?"undefined":s(e))&&e.length?[].slice.call(e):"object"===(void 0===e?"undefined":s(e))&&1===e.nodeType?[e]:[]},f=function(e,t){return"string"==typeof t?a.call(e,t):"object"===(void 0===t?"undefined":s(t))&&t.length?t.indexOf(e)>=0:"object"===(void 0===t?"undefined":s(t))&&1===t.nodeType&&e===t},v=function(e,t){var n=new Array(t);for(var r in n){var o=e.indexOf(r);o>=0&&e.splice(o,1)}return e},d=function(e){return{left:"right",up:"down",right:"left",down:"up"}[e]},y=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var u,a=e[Symbol.iterator]();!(r=(u=a.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},h=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var b={selector:"",straightOnly:!1,straightOverlapThreshold:.35,rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:[],navigableFilter:null,eventPrefix:"sn:",idPoolPrefix:"section-"},p=0,E=!1,w=!1,_={},k=0,S="",I="",x=!1,L=null;return function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t&&(b=Object.assign(b,t))}return m(e,[{key:"init",value:function(){E||(this.bindEvents(),E=!0),e.focus()}},{key:"destroy",value:function(){this.clear(),this.unbindEvents()}},{key:"clear",value:function(){E=!1,_={},k=0,p=0,S="",I="",x=!1,L=null}},{key:"bindEvents",value:function(){this.addEventListener(window,"mouseover",this._onMouseOver),this.addEventListener(window,"mousedown",this._onMouseDown),this.addEventListener(window,"keydown",this._onKeyDown),this.addEventListener(window,"keyup",this._onKeyUp),this.addEventListener(window,"focus",this._onFocus,!0),this.addEventListener(window,"blur",this._onBlur,!0),this.addEventListener(document,b.eventPrefix+"focused",this._handleFocused)}},{key:"unbindEvents",value:function(){this.removeEventListener(window,"mouseover",this._onMouseOver),this.removeEventListener(window,"mousedown",this._onMouseDown),this.removeEventListener(window,"keydown",this._onKeyDown),this.removeEventListener(window,"keyup",this._onKeyUp),this.removeEventListener(window,"focus",this._onFocus,!0),this.removeEventListener(window,"blur",this._onBlur,!0),this.removeEventListener(document,b.eventPrefix+"focused",this._handleFocused)}},{key:"addFocusable",value:function(t,n){if(t&&!e._getSectionId(document.getElementById(t.id))){this.removeFocusable(t);var r=e.add(t);n&&this.addEventListener(t.selector,b.eventPrefix+"enter-down",n),this._makeFocusable(r)}}},{key:"removeFocusable",value:function(t,n){var r=e._getSectionId(document.getElementById(t.id));r&&(this.remove(r),n&&this.removeEventListener(b.eventPrefix+"enter-down",n))}},{key:"setDefaultSection",value:function(e){if(e){if(!_[e])throw new Error("Section "+e+" doesn't exist!");S=e}else S=""}},{key:"getCurrentFocusedPath",value:function(){return L}},{key:"setCurrentFocusedPath",value:function(t){L=t,e.focus(t)}},{key:"addEventListener",value:function(e,n,r){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t.addListener(e,n,r,o)}},{key:"removeEventListener",value:function(e,n,r){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t.removeListener(e,n,r,o)}},{key:"_makeFocusable",value:function(e){var t=function(e){var t=e.tabIndexIgnoreList||b.tabIndexIgnoreList;l(e.selector).forEach((function(e){f(e,t)||e.getAttribute("tabindex")||e.setAttribute("tabindex","-1")}))};if(e){if(!_[e])throw new Error("Section "+e+" doesn't exist!");t(_[e])}else for(var n in _)t(_[n])}},{key:"_onMouseOver",value:function(t){var n=t.target;if(n&&(n.classList.contains("focusable")||n.closest(".focusable"))){var r=n.classList.contains("focusable")?n:n.closest(".focusable");return e._focusElement(r,e._getSectionId(r)),c(t)}}},{key:"_onMouseDown",value:function(t){var n=t.target;if(n&&(n.classList.contains("focusable")||n.closest(".focusable"))){var r=n.classList.contains("focusable")?n:n.closest(".focusable");return e.fireEvent(r,"enter-down")?void 0:c(t)}}},{key:"_onKeyDown",value:function(t){if(console.log(">>>> _onKeyDown: ",u(t.keyCode)),!(!k||w||t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)){var n=e._getCurrentFocusedElement(),r=e._getSectionId(n),o=u(t.keyCode);if(o){if("enter"===o&&n&&r&&!e.fireEvent(n,"enter-down"))return c(t);if(!n&&(I&&(n=e._getSectionLastFocusedElement(I)),!n))return this.focusSection(),c(t);if(r){var i={direction:o,sectionId:r,cause:"keydown"};return e.fireEvent(n,"willmove",i)&&e._focusNext(o,n,r),c(t)}}}}},{key:"_onKeyUp",value:function(t){if(!(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)&&!w&&k&&"center"===u(t.keyCode)){var n=e._getCurrentFocusedElement();n&&e._getSectionId(n)&&(e.fireEvent(n,"enter-up")||c(t))}}},{key:"_onFocus",value:function(t){var n=t.target;if(n!==window&&n!==document&&k&&!x){var r=e._getSectionId(n);if(r){if(w)return void e._focusChanged(n,r);var o={sectionId:r,native:!0};e.fireEvent(n,"willfocus",o)?(e.fireEvent(n,"focused",o,!1),e._focusChanged(n,r)):(x=!0,n.blur(),x=!1)}}}},{key:"_onBlur",value:function(t){var n=t.target;if(n!==window&&n!==document&&!w&&k&&!x&&e._getSectionId(n)){var r={native:!0};e.fireEvent(n,"willunfocus",r)?e.fireEvent(n,"unfocused",r,!1):(x=!0,setTimeout((function(){n.focus(),x=!1})))}}},{key:"_handleFocused",value:function(e){L!==e.detail.sectionId&&this.setCurrentFocusedPath(e.detail.sectionId)}}],[{key:"set",value:function(){for(var e=void 0,t=void 0,n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];if("object"===g(r[0]))t=r[0];else{if("string"!=typeof r[0]||"object"!==g(r[1]))return;if(e=r[0],t=r[1],!_[e])throw new Error("Section "+e+" doesn't exist!")}for(var i in t)void 0!==b[i]&&(e?_[e][i]=t[i]:void 0!==t[i]&&(b[i]=t[i]))}},{key:"add",value:function(){for(var t=void 0,n=void 0,r=arguments.length,o=Array(r),i=0;i<r;i++)o[i]=arguments[i];if("object"===g(o[0])?n=o[0]:"string"==typeof o[0]&&"object"===g(o[1])&&(t=o[0],n=o[1]),t||(t="string"==typeof n.id?n.id:e._generateId()),_[t])throw new Error("Section "+t+" has already existed!");return _[t]={},k++,e.set(t,n),t}},{key:"remove",value:function(e){if(!e||"string"!=typeof e)throw new Error('Please assign the "sectionId"!');return!!_[e]&&(_[e]=void 0,_=h({},_),k--,!0)}},{key:"disable",value:function(e){return!!_[e]&&(_[e].disabled=!0,!0)}},{key:"enable",value:function(e){return!!_[e]&&(_[e].disabled=!1,!0)}},{key:"pause",value:function(){w=!0}},{key:"resume",value:function(){w=!1}},{key:"focus",value:function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var o=n[0],i=n[1];"boolean"==typeof o&&void 0===i&&(i=o,o=void 0);var u=!w&&i;u&&e.pause();var a=void 0;if(o)if("string"==typeof o)a=_[o]?e._focusSection(o):e._focusExtendedSelector(o);else{var s=e._getSectionId(o);e._isNavigable(o,s)&&(a=e._focusElement(o,s))}else a=e._focusSection();return u&&e.resume(),a}},{key:"move",value:function(t,n){var r=t.toLowerCase();if(!d(r))return!1;var o=n?l(n)[0]:e._getCurrentFocusedElement();if(!o)return!1;var i=e._getSectionId(o);if(!i)return!1;var u={direction:r,sectionId:i,cause:"api"};return!!e.fireEvent(o,"willmove",u)&&e._focusNext(r,o,i)}},{key:"fireEvent",value:function(e,n,r){var o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=""+b.eventPrefix+n;return t.fireEvent(e,i,r,o)}},{key:"_navigate",value:function(e,t,n,i){if(!(e&&t&&n&&n.length))return null;var u=o(e);if(!u)return null;var a=[];if(n.forEach((function(e){var t=o(e);t&&a.push(t)})),!a.length)return null;var s,c=(s=u,{nearestIsBetter:function(e){var t=[s.center.x,s.center.y];return r.calculate(t,[e.center.x,e.center.y])},nearPlumbLineIsBetter:function(e){var t=void 0;return(t=e.center.x<s.center.x?s.center.x-e.right:e.left-s.center.x)<0?0:t},nearHorizonIsBetter:function(e){var t=void 0;return(t=e.center.y<s.center.y?s.center.y-e.bottom:e.top-s.center.y)<0?0:t},nearTargetLeftIsBetter:function(e){var t=void 0;return(t=e.center.x<s.center.x?s.left-e.right:e.left-s.left)<0?0:t},nearTargetTopIsBetter:function(e){var t=void 0;return(t=e.center.y<s.center.y?s.top-e.bottom:e.top-s.top)<0?0:t},topIsBetter:function(e){return e.top},bottomIsBetter:function(e){return-1*e.bottom},leftIsBetter:function(e){return e.left},rightIsBetter:function(e){return-1*e.right}}),l=void 0;switch(t){case"left":l=[{group:a=a.filter((function(e){return e.center.x<u.center.x})),distance:[c.nearHorizonIsBetter,c.nearestIsBetter,c.topIsBetter]}];break;case"right":l=[{group:a=a.filter((function(e){return e.center.x>u.center.x})),distance:[c.nearHorizonIsBetter,c.nearestIsBetter,c.topIsBetter]}];break;case"up":l=[{group:a=a.filter((function(e){return e.center.y<u.center.y})),distance:[c.nearestIsBetter,c.nearHorizonIsBetter,c.leftIsBetter]}];break;case"down":l=[{group:a=a.filter((function(e){return e.center.y>u.center.y})),distance:[c.nearestIsBetter,c.nearPlumbLineIsBetter,c.topIsBetter,c.nearTargetLeftIsBetter]}];break;default:return null}i.straightOnly&&l.pop();var f=function(e){for(var t=void 0,n=0;n<e.length;n++)if(e[n].group.length){t=e[n];break}if(!t)return null;var r=t.distance;return t.group.sort((function(e,t){for(var n=0;n<r.length;n++){var o=r[n],i=o(e)-o(t);if(i)return i}return 0})),t.group}(l);if(!f)return null;var v=void 0;if(i.rememberSource&&i.previous&&i.previous.destination===e&&i.previous.reverse===t)for(var d in f)if(d.element===i.previous.target){v=d.element;break}return v||(v=f[0].element),v}},{key:"_isNavigable",value:function(e,t,n){if(!e||!t||!_[t]||_[t].disabled)return!1;if(e.offsetWidth<=0&&e.offsetHeight<=0||e.hasAttribute("disabled"))return!1;if(n&&!f(e,_[t].selector))return!1;if("function"==typeof _[t].navigableFilter){if(!1===_[t].navigableFilter(e,t))return!1}else if("function"==typeof b.navigableFilter&&!1===b.navigableFilter(e,t))return!1;return!0}},{key:"_focusNext",value:function(t,n,r){var o=n.getAttribute("data-sn-"+t);if("string"==typeof o)return!(""===o||!e._focusExtendedSelector(o,t))||(e._fireNavigateFailed(n,t),!1);var i={},u=[];for(var a in _)i[a]=e._getSectionNavigableElements(a),u=u.concat(i[a]);var s=h({},b,_[r]),c=void 0,l=void 0;if("self-only"===s.restrict||"self-first"===s.restrict){var f=i[r];l=v(f,n),(c=e._navigate(n,t,l,s))||"self-first"!==s.restrict||(l=v(u,f),c=e._navigate(n,t,l,s))}else l=v(u,n),c=e._navigate(n,t,l,s);if(c){_[r].previous={target:n,destination:c,reverse:d(t)};var y=e._getSectionId(c);if(r!==y){var g=e._gotoLeaveFor(r,t);if(g)return!0;if(null===g)return e._fireNavigateFailed(n,t),!1;var m=void 0;switch(_[y].enterTo){case"last-focused":m=e._getSectionLastFocusedElement(y)||e._getSectionDefaultElement(y);break;case"default-element":m=e._getSectionDefaultElement(y)}m&&(c=m)}return e._focusElement(c,y,t)}return!!e._gotoLeaveFor(r,t)||(e._fireNavigateFailed(n,t),!1)}},{key:"_focusChanged",value:function(t,n){var r=n||e._getSectionId(t);r&&(_[r].lastFocusedElement=t,I=r)}},{key:"_focusElement",value:function(t,n,r){if(!t)return!1;var o=e._getCurrentFocusedElement(),i=function(){o&&o.blur(),t.focus(),e._focusChanged(t,n)};if(x)return i(),!0;if(x=!0,w)return i(),x=!1,!0;if(o){var u={nextElement:t,nextSectionId:n,direction:r,native:!1};if(!e.fireEvent(o,"willunfocus",u))return x=!1,!1;o.blur(),e.fireEvent(o,"unfocused",u,!1)}var a={previousElement:o,sectionId:n,direction:r,native:!1};return e.fireEvent(t,"willfocus",a)?(t.focus(),e.fireEvent(t,"focused",a,!1),x=!1,e._focusChanged(t,n),!0):(x=!1,!1)}},{key:"_focusSection",value:function(t){var n=[],r=function(e){e&&n.indexOf(e)<0&&_[e]&&!_[e].disabled&&n.push(e)};t?r(t):(r(S),r(I),Object.keys(_).map(r));for(var o=0;o<n.length;o++){var i=n[o],u=void 0;if(u="last-focused"===_[i].enterTo?e._getSectionLastFocusedElement(i)||e._getSectionDefaultElement(i)||e._getSectionNavigableElements(i)[0]:e._getSectionDefaultElement(i)||e._getSectionLastFocusedElement(i)||e._getSectionNavigableElements(i)[0])return e._focusElement(u,i)}return!1}},{key:"_focusExtendedSelector",value:function(t,n){if("@"===t.charAt(0)){if(1===t.length)return e._focusSection();var r=t.substr(1);return e._focusSection(r)}var o=l(t),i=y(o,1)[0];if(i){var u=e._getSectionId(i);if(e._isNavigable(i,u))return e._focusElement(i,u,n)}return!1}},{key:"_getSectionId",value:function(e){for(var t in _)if(!_[t].disabled&&e&&f(e,_[t].selector))return t}},{key:"_getSectionNavigableElements",value:function(t){return l(_[t].selector).filter((function(n){return e._isNavigable(n,t)}))}},{key:"_getSectionDefaultElement",value:function(t){var n=_[t].defaultElement;if(!n)return null;if("string"==typeof n){var r=l(n);n=y(r,1)[0]}return e._isNavigable(n,t,!0)?n:null}},{key:"_getSectionLastFocusedElement",value:function(t){var n=_[t]&&_[t].lastFocusedElement;return e._isNavigable(n,t,!0)?n:null}},{key:"_getCurrentFocusedElement",value:function(){var e=document.activeElement;if(e&&e!==document.body)return e}},{key:"_fireNavigateFailed",value:function(t,n){return e.fireEvent(t,"navigatefailed",{direction:n},!1)}},{key:"_gotoLeaveFor",value:function(t,n){if(_[t].leaveFor&&void 0!==_[t].leaveFor[n]){var r=_[t].leaveFor[n];if("string"==typeof r)return""===r?null:e._focusExtendedSelector(r,n);var o=e._getSectionId(r);if(e._isNavigable(r,o))return e._focusElement(r,o,n)}return!1}},{key:"_generateId",value:function(){var e=void 0;do{e=b.idPoolPrefix+String(++p)}while(_[e]);return e}}]),e}()}));
